<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al Razy Pharmacy - Advanced Security Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
        }
        body, html {
            height: 100%;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            min-height: 100vh;
            box-sizing: border-box;
        }
        .header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .status-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }
        .status-card.critical {
            border-left-color: #dc3545;
        }
        .status-card.high {
            border-left-color: #fd7e14;
        }
        .status-card.medium {
            border-left-color: #ffc107;
        }
        .status-card.low {
            border-left-color: #28a745;
        }
        .status-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }
        .status-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
        }
        .status-indicator.offline {
            background: #dc3545;
        }
        .status-indicator.warning {
            background: #ffc107;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 14px;
        }
        .metric-value {
            font-weight: bold;
            color: #007bff;
        }
        .threat-level {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .threat-level.critical {
            background: #dc3545;
            color: white;
        }
        .threat-level.high {
            background: #fd7e14;
            color: white;
        }
        .threat-level.medium {
            background: #ffc107;
            color: black;
        }
        .threat-level.low {
            background: #28a745;
            color: white;
        }
        .threat-level.minimal {
            background: #6c757d;
            color: white;
        }
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            align-items: start;
        }
        .events-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 600px;
            overflow-y: auto;
        }
        .controls-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .event-item {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .event-item:last-child {
            border-bottom: none;
        }
        .event-info {
            flex: 1;
        }
        .event-type {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .event-details {
            font-size: 14px;
            color: #666;
        }
        .event-time {
            font-size: 12px;
            color: #999;
        }
        .control-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .control-section:last-child {
            border-bottom: none;
        }
        .control-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        button.success {
            background: #28a745;
        }
        button.success:hover {
            background: #1e7e34;
        }
        .live-cameras-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .camera-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        .camera-feed {
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 16/9;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .camera-feed img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }
        .camera-feed.loading {
            background: linear-gradient(45deg, #333, #555, #333);
            background-size: 200% 200%;
            animation: loading-gradient 2s ease infinite;
        }
        .camera-feed.error {
            background: #2c1810;
            border-color: #8b4513;
        }
        .camera-feed.no-signal {
            background: radial-gradient(circle, #1a1a1a, #000);
        }
        @keyframes loading-gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .camera-feed.active {
            border-color: #28a745;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.3);
        }
        .camera-feed.detecting {
            border-color: #dc3545;
            box-shadow: 0 0 15px rgba(220, 53, 69, 0.5);
            animation: pulse-red 1s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 15px rgba(220, 53, 69, 0.5); }
            50% { box-shadow: 0 0 25px rgba(220, 53, 69, 0.8); }
            100% { box-shadow: 0 0 15px rgba(220, 53, 69, 0.5); }
        }
        .camera-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
        }
        .camera-status {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
        }
        .camera-status.offline {
            background: #dc3545;
        }
        .camera-status.detecting {
            background: #ffc107;
            animation: blink 0.5s infinite;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        .detection-overlay {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            padding: 8px;
            border-radius: 5px;
            font-size: 11px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        .detection-overlay.visible {
            transform: translateY(0);
        }
        .toggle-cameras {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        .toggle-cameras:hover {
            background: linear-gradient(135deg, #138496, #117a8b);
        }
        
        /* System Log Styling */
        .log-container {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .log-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .log-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .log-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .log-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .log-entry {
            margin: 2px 0;
            padding: 3px 6px;
            border-radius: 3px;
            border-left: 3px solid transparent;
        }
        
        .log-entry.log-info {
            background-color: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        
        .log-entry.log-warning {
            background-color: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        
        .log-entry.log-error {
            background-color: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        
        .log-entry.log-success {
            background-color: #d1ecf1;
            border-left-color: #17a2b8;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîí Al Razy Pharmacy - Advanced Security System</h1>
            <p>Intelligent Theft Prevention with AI-Powered Analysis</p>
        </div>

        <!-- Navigation Bar -->
        <div class="nav-bar">
            <a href="/security-dashboard" class="nav-link current">
                üîí Security Dashboard
            </a>
            <a href="/streaming-dashboard" class="nav-link streaming">
                üìπ Live Cameras
            </a>
            <a href="/multi-camera" class="nav-link streaming">
                üì∫ Multi-Camera View
            </a>
            <a href="/analytics-dashboard" class="nav-link analytics">
                üìä Analytics
            </a>
            <a href="/" class="nav-link">
                üè† Home
            </a>
        </div>

        <!-- System Status Overview -->
        <div class="status-grid">
            <div class="status-card" id="systemStatus">
                <div class="status-header">
                    <div class="status-title">System Status</div>
                    <div class="status-indicator" id="systemIndicator"></div>
                </div>
                <div class="metric">
                    <span>Uptime:</span>
                    <span class="metric-value" id="systemUptime">--</span>
                </div>
                <div class="metric">
                    <span>Active Cameras:</span>
                    <span class="metric-value" id="activeCameras">--</span>
                </div>
                <div class="metric">
                    <span>AI Analysis:</span>
                    <span class="metric-value" id="aiStatus">--</span>
                </div>
            </div>

            <div class="status-card" id="threatStatus">
                <div class="status-header">
                    <div class="status-title">Threat Assessment</div>
                    <div class="status-indicator" id="threatIndicator"></div>
                </div>
                <div class="metric">
                    <span>Risk Level:</span>
                    <span class="threat-level" id="riskLevel">--</span>
                </div>
                <div class="metric">
                    <span>Active People:</span>
                    <span class="metric-value" id="activePeople">--</span>
                </div>
                <div class="metric">
                    <span>Risk Score:</span>
                    <span class="metric-value" id="riskScore">--</span>
                </div>
            </div>

            <div class="status-card" id="recordingStatus">
                <div class="status-header">
                    <div class="status-title">Recording System</div>
                    <div class="status-indicator" id="recordingIndicator"></div>
                </div>
                <div class="metric">
                    <span>Active Recordings:</span>
                    <span class="metric-value" id="activeRecordings">--</span>
                </div>
                <div class="metric">
                    <span>Total Storage:</span>
                    <span class="metric-value" id="totalStorage">--</span>
                </div>
                <div class="metric">
                    <span>Today's Records:</span>
                    <span class="metric-value" id="todayRecords">--</span>
                </div>
            </div>

            <div class="status-card" id="alertStatus">
                <div class="status-header">
                    <div class="status-title">Alert System</div>
                    <div class="status-indicator" id="alertIndicator"></div>
                </div>
                <div class="metric">
                    <span>Webhooks Online:</span>
                    <span class="metric-value" id="webhooksOnline">--</span>
                </div>
                <div class="metric">
                    <span>Alerts Sent Today:</span>
                    <span class="metric-value" id="alertsSent">--</span>
                </div>
                <div class="metric">
                    <span>Success Rate:</span>
                    <span class="metric-value" id="alertSuccessRate">--</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Events Panel -->
            <div class="events-panel">
                <h3>üö® Recent Security Events</h3>
                <div class="analytics-summary">
                    <div class="analytics-item">
                        <div class="analytics-number" id="totalEvents">0</div>
                        <div class="analytics-label">Total Events</div>
                    </div>
                    <div class="analytics-item">
                        <div class="analytics-number" id="confirmedThreats">0</div>
                        <div class="analytics-label">Confirmed Threats</div>
                    </div>
                    <div class="analytics-item">
                        <div class="analytics-number" id="falsePositives">0</div>
                        <div class="analytics-label">False Positives</div>
                    </div>
                    <div class="analytics-item">
                        <div class="analytics-number" id="averageResponse">0</div>
                        <div class="analytics-label">Avg Response (s)</div>
                    </div>
                </div>
                <div id="eventsContainer">
                    <div class="event-item">
                        <div class="event-info">
                            <div class="event-type">No recent events</div>
                            <div class="event-details">System monitoring for suspicious activities...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls Panel -->
            <div class="controls-panel">
                <!-- System Controls -->
                <div class="control-section">
                    <div class="control-title">System Controls</div>
                    <button onclick="refreshStatus()">üîÑ Refresh Status</button>
                    <button onclick="processAllFrames()" class="success">üîç Analyze All Cameras</button>
                    <button onclick="testWebhooks()">üì° Test Alerts</button>
                    <button onclick="simulateDetection()">‚ö†Ô∏è Test Detection</button>
                </div>

                <!-- Suspicious Activity Detection Controls -->
                <div class="control-section">
                    <div class="control-title">üîç Suspicious Activity Detection</div>
                    <button onclick="dashboard.startAllSuspiciousActivityDetection()" class="success">‚ñ∂Ô∏è Start All Detection</button>
                    <button onclick="dashboard.stopAllSuspiciousActivityDetection()" class="danger">‚èπÔ∏è Stop All Detection</button>
                    <button onclick="dashboard.restartDetection()">üîÑ Restart Detection</button>
                </div>

                <!-- Camera Status -->
                <div class="control-section">
                    <div class="control-title">Camera Status</div>
                    <div class="camera-grid" id="cameraGrid">
                        <div class="camera-card">Camera 1<br><small>Connecting...</small></div>
                        <div class="camera-card">Camera 2<br><small>Connecting...</small></div>
                        <div class="camera-card">Camera 3<br><small>Connecting...</small></div>
                        <div class="camera-card">Camera 4<br><small>Connecting...</small></div>
                    </div>
                </div>

                <!-- Recording Controls -->
                <div class="control-section">
                    <div class="control-title">Recording System</div>
                    <div class="recording-status" id="recordingInfo">
                        <div><strong>Status:</strong> <span id="recordingStatusText">Ready</span></div>
                        <div><strong>Active:</strong> <span id="activeRecordingCount">0</span> recordings</div>
                    </div>
                    <button onclick="viewRecordings()">üìπ View Recordings</button>
                    <button onclick="cleanupOldRecordings()" class="danger">üóëÔ∏è Cleanup Old</button>
                </div>

                <!-- Webhook Status -->
                <div class="control-section">
                    <div class="control-title">Alert Webhooks</div>
                    <div id="webhookContainer">
                        <div class="webhook-status">
                            <span>No webhooks configured</span>
                            <span>‚ûñ</span>
                        </div>
                    </div>
                    <button onclick="addWebhook()">‚ûï Add Webhook</button>
                </div>

                <!-- System Log -->
                <div class="control-section">
                    <div class="control-title">System Log</div>
                    <div class="log-container" id="systemLog">
                        <div class="log-entry log-info">[INFO] Security dashboard loaded</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Cameras Section -->
        <div class="live-cameras-section">
            <h3>üìπ Live Camera Feeds</h3>
            <div class="camera-grid" id="liveCameraGrid">
                <div class="camera-feed loading" id="liveCamera1">
                    <img id="cameraImage1" style="display: none;" alt="Camera 1 Feed">
                    <div class="camera-overlay">Camera 1</div>
                    <div class="camera-status" id="cameraStatus1"></div>
                    <div class="detection-overlay" id="detectionOverlay1">Suspicious Activity Detected</div>
                </div>
                <div class="camera-feed loading" id="liveCamera2">
                    <img id="cameraImage2" style="display: none;" alt="Camera 2 Feed">
                    <div class="camera-overlay">Camera 2</div>
                    <div class="camera-status" id="cameraStatus2"></div>
                    <div class="detection-overlay" id="detectionOverlay2">Suspicious Activity Detected</div>
                </div>
                <div class="camera-feed loading" id="liveCamera3">
                    <img id="cameraImage3" style="display: none;" alt="Camera 3 Feed">
                    <div class="camera-overlay">Camera 3</div>
                    <div class="camera-status" id="cameraStatus3"></div>
                    <div class="detection-overlay" id="detectionOverlay3">Suspicious Activity Detected</div>
                </div>
                <div class="camera-feed loading" id="liveCamera4">
                    <img id="cameraImage4" style="display: none;" alt="Camera 4 Feed">
                    <div class="camera-overlay">Camera 4</div>
                    <div class="camera-status" id="cameraStatus4"></div>
                    <div class="detection-overlay" id="detectionOverlay4">Suspicious Activity Detected</div>
                </div>
            </div>
            <button class="toggle-cameras" id="toggleCamerasButton">üîÑ Toggle Cameras</button>
        </div>
    </div>

    <script>
        class SecurityDashboard {
            constructor() {
                this.refreshInterval = null;
                this.isRefreshing = false;
                this.destroyed = false;
                this.camerasVisible = true;
                this.detectionStates = {1: false, 2: false, 3: false, 4: false};
                
                // WebSocket connections
                this.streamWs = null;
                this.motionWs = null;
                this.statusWs = null;
                
                this.startAutoRefresh();
                this.addLog('Security dashboard initialized', 'info');
                this.initializeCameraSection();
                this.connectWebSockets();
                
                // Add cleanup on page unload
                window.addEventListener('beforeunload', () => this.cleanup());
            }

            cleanup() {
                this.destroyed = true;
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                    this.refreshInterval = null;
                }
                
                // Close WebSocket connections
                if (this.streamWs) {
                    this.streamWs.close();
                }
                if (this.motionWs) {
                    this.motionWs.close();
                }
                if (this.statusWs) {
                    this.statusWs.close();
                }
            }

            async startAutoRefresh() {
                // Initial load
                await this.refreshStatus();
                
                // Clear any existing interval first
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                }
                
                // Auto refresh every 10 seconds (increased to reduce load)
                this.refreshInterval = setInterval(() => {
                    if (!this.isRefreshing) {
                        this.refreshStatus();
                    }
                }, 10000);
            }

            async refreshStatus() {
                if (this.isRefreshing || this.destroyed) return;
                this.isRefreshing = true;

                try {
                    // Get system status
                    const statusResponse = await fetch('/security/status');
                    const statusData = await statusResponse.json();
                    this.updateSystemStatus(statusData);

                    // Get risk assessment
                    const riskResponse = await fetch('/security/risk-assessment');
                    const riskData = await riskResponse.json();
                    this.updateRiskAssessment(riskData.risk_assessment);

                    // Get recent events
                    const eventsResponse = await fetch('/security/events?hours=24');
                    const eventsData = await eventsResponse.json();
                    this.updateEvents(eventsData.events || []);

                    // Get recording status
                    const recordingResponse = await fetch('/recordings/active');
                    const recordingData = await recordingResponse.json();
                    this.updateRecordingStatus(recordingData);

                    // Get webhook status
                    const webhookResponse = await fetch('/webhooks/status');
                    const webhookData = await webhookResponse.json();
                    this.updateWebhookStatus(webhookData);

                    this.addLog('Status refreshed successfully', 'info');
                    
                } catch (error) {
                    console.error('Error refreshing status:', error);
                    this.addLog(`Error refreshing status: ${error.message}`, 'error');
                } finally {
                    this.isRefreshing = false;
                }
            }

            connectWebSockets() {
                this.connectStreamingWebSocket();
                this.connectMotionWebSocket();
                this.connectStatusWebSocket();
            }

            connectStreamingWebSocket() {
                const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
                this.streamWs = new WebSocket(`${protocol}//${location.host}/ws/camera-streams`);
                
                this.streamWs.onopen = () => {
                    console.log('Camera streaming WebSocket connected');
                    this.addLog('Camera streaming connected', 'info');
                    this.startAllStreams();
                };
                
                this.streamWs.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleStreamingMessage(data);
                };
                
                this.streamWs.onclose = () => {
                    console.log('Camera streaming WebSocket disconnected');
                    this.addLog('Camera streaming disconnected', 'warning');
                    // Attempt to reconnect after 3 seconds
                    setTimeout(() => this.connectStreamingWebSocket(), 3000);
                };
                
                this.streamWs.onerror = (error) => {
                    console.error('Camera streaming WebSocket error:', error);
                    this.addLog('Camera streaming error', 'error');
                };
            }

            connectMotionWebSocket() {
                const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
                this.motionWs = new WebSocket(`${protocol}//${location.host}/ws/motion-detection`);
                
                this.motionWs.onopen = () => {
                    console.log('Motion detection WebSocket connected');
                    this.addLog('Motion detection connected', 'info');
                    this.startAllMotionDetection();
                };
                
                this.motionWs.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleMotionMessage(data);
                };
                
                this.motionWs.onclose = () => {
                    console.log('Motion detection WebSocket disconnected');
                    setTimeout(() => this.connectMotionWebSocket(), 3000);
                };
                
                this.motionWs.onerror = (error) => {
                    console.error('Motion detection WebSocket error:', error);
                };
            }

            connectStatusWebSocket() {
                const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
                this.statusWs = new WebSocket(`${protocol}//${location.host}/ws/system-status`);
                
                this.statusWs.onopen = () => {
                    console.log('System status WebSocket connected');
                };
                
                this.statusWs.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleStatusMessage(data);
                };
                
                this.statusWs.onclose = () => {
                    console.log('System status WebSocket disconnected');
                    setTimeout(() => this.connectStatusWebSocket(), 3000);
                };
                
                this.statusWs.onerror = (error) => {
                    console.error('System status WebSocket error:', error);
                };
            }

            handleStreamingMessage(data) {
                switch (data.type) {
                    case 'camera_frame':
                        this.updateCameraFrame(data.camera_id, data.frame, data.resolution);
                        break;
                    case 'stream_started':
                        this.markCameraStreaming(data.camera_id, true);
                        break;
                    case 'stream_stopped':
                        this.markCameraStreaming(data.camera_id, false);
                        break;
                    case 'all_streams_started':
                        for (let i = 1; i <= 4; i++) {
                            this.markCameraStreaming(i, true);
                        }
                        this.addLog('All camera streams started', 'info');
                        break;
                    case 'all_streams_stopped':
                        for (let i = 1; i <= 4; i++) {
                            this.markCameraStreaming(i, false);
                        }
                        this.addLog('All camera streams stopped', 'info');
                        break;
                    case 'error':
                        console.error('Streaming error:', data.message);
                        this.addLog(`Streaming error: ${data.message}`, 'error');
                        break;
                }
            }

            handleMotionMessage(data) {
                if (data.type === 'suspicious_activity_detected') {
                    const activityType = data.activity_type.replace('_', ' ').toUpperCase();
                    const confidencePercent = (data.confidence * 100).toFixed(1);
                    
                    this.addLog(`üö® SUSPICIOUS ACTIVITY: ${activityType} on Camera ${data.camera_id} (${confidencePercent}% confidence)`, 'warning');
                    this.setDetectionState(data.camera_id, true);
                    
                    // Update detection overlay with specific activity details
                    const overlayElement = document.getElementById(`detectionOverlay${data.camera_id}`);
                    if (overlayElement) {
                        overlayElement.textContent = `‚ö†Ô∏è ${activityType} - ${data.threat_level}`;
                        overlayElement.className = 'detection-overlay visible';
                    }
                    
                    // Clear detection after 10 seconds for suspicious activities (longer than basic motion)
                    setTimeout(() => {
                        this.setDetectionState(data.camera_id, false);
                        if (overlayElement) {
                            overlayElement.className = 'detection-overlay';
                            overlayElement.textContent = 'Suspicious Activity Detected';
                        }
                    }, 10000);
                }
            }

            handleStatusMessage(data) {
                if (data.type === 'system_status') {
                    // Update camera status indicators based on WebSocket data
                    this.updateCameraConnectionStatus(data.cameras);
                }
            }

            updateCameraFrame(cameraId, frameBase64, resolution) {
                const imageElement = document.getElementById(`cameraImage${cameraId}`);
                const feedElement = document.getElementById(`liveCamera${cameraId}`);
                const statusElement = document.getElementById(`cameraStatus${cameraId}`);
                
                if (!imageElement || !feedElement || !statusElement) return;

                if (frameBase64) {
                    // Update image source with base64 frame
                    imageElement.src = `data:image/jpeg;base64,${frameBase64}`;
                    imageElement.style.display = 'block';
                    
                    // Update feed element state
                    feedElement.className = `camera-feed active ${this.detectionStates[cameraId] ? 'detecting' : ''}`;
                    statusElement.className = `camera-status ${this.detectionStates[cameraId] ? 'detecting' : ''}`;
                    
                    // Remove loading state and error text
                    feedElement.classList.remove('loading', 'error');
                    const errorText = feedElement.querySelector('.camera-error-text');
                    if (errorText) {
                        errorText.remove();
                    }
                }
            }

            markCameraStreaming(cameraId, isStreaming) {
                const feedElement = document.getElementById(`liveCamera${cameraId}`);
                const statusElement = document.getElementById(`cameraStatus${cameraId}`);
                
                if (!feedElement || !statusElement) return;

                if (isStreaming) {
                    feedElement.classList.remove('loading', 'error');
                    statusElement.classList.remove('offline');
                } else {
                    this.setCameraError(cameraId, 'Stream stopped');
                }
            }

            setDetectionState(cameraId, isDetecting) {
                this.detectionStates[cameraId] = isDetecting;
                this.updateCameraFeed(cameraId, isDetecting);
            }

            updateCameraConnectionStatus(cameras) {
                for (let cameraId = 1; cameraId <= 4; cameraId++) {
                    const cameraInfo = cameras[cameraId.toString()];
                    if (cameraInfo && cameraInfo.status !== 'connected') {
                        this.setCameraError(cameraId, 'Offline');
                    }
                }
            }

            startAllStreams() {
                if (this.streamWs && this.streamWs.readyState === WebSocket.OPEN) {
                    // Request streaming for all cameras
                    for (let cameraId = 1; cameraId <= 4; cameraId++) {
                        this.streamWs.send(JSON.stringify({
                            type: 'start_stream',
                            camera_id: cameraId,
                            fps: 15,
                            quality: 85
                        }));
                    }
                }
            }

            startAllMotionDetection() {
                if (this.motionWs && this.motionWs.readyState === WebSocket.OPEN) {
                    // Use new batch command for all cameras at once
                    this.motionWs.send(JSON.stringify({
                        type: 'start_all_motion_detection',
                        interval: 3.0  // 3-second interval for suspicious activity detection
                    }));
                    this.addLog('üîç Starting suspicious activity detection on all cameras', 'info');
                }
            }

            startAllSuspiciousActivityDetection() {
                this.startAllMotionDetection();  // Uses the updated method
                this.addLog('üîç Starting suspicious activity detection on all cameras', 'success');
            }

            stopAllSuspiciousActivityDetection() {
                if (this.motionWs && this.motionWs.readyState === WebSocket.OPEN) {
                    this.motionWs.send(JSON.stringify({
                        type: 'stop_all_motion_detection'
                    }));
                    this.addLog('‚èπÔ∏è Stopping suspicious activity detection on all cameras', 'warning');
                }
            }

            restartDetection() {
                this.addLog('üîÑ Restarting suspicious activity detection...', 'info');
                this.stopAllSuspiciousActivityDetection();
                setTimeout(() => {
                    this.startAllSuspiciousActivityDetection();
                }, 2000);
            }

            setCameraError(cameraId, errorMessage = 'Connection error') {
                const imageElement = document.getElementById(`cameraImage${cameraId}`);
                const feedElement = document.getElementById(`liveCamera${cameraId}`);
                const statusElement = document.getElementById(`cameraStatus${cameraId}`);
                
                if (!imageElement || !feedElement || !statusElement) return;

                imageElement.style.display = 'none';
                feedElement.className = 'camera-feed error';
                statusElement.className = 'camera-status offline';
                
                // Add error text if not already present
                let errorText = feedElement.querySelector('.camera-error-text');
                if (!errorText) {
                    errorText = document.createElement('div');
                    errorText.className = 'camera-error-text';
                    errorText.style.cssText = `
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        color: #ff6b6b;
                        font-size: 12px;
                        text-align: center;
                        font-weight: bold;
                    `;
                    feedElement.appendChild(errorText);
                }
                errorText.textContent = errorMessage;
            }

            updateSystemStatus(data) {
                const isOnline = data.running || false;
                const uptime = data.uptime_hours || 0;
                
                // Update system status
                document.getElementById('systemIndicator').className = `status-indicator ${isOnline ? '' : 'offline'}`;
                document.getElementById('systemUptime').textContent = `${uptime.toFixed(1)}h`;
                document.getElementById('activeCameras').textContent = Object.keys(data.components || {}).length;
                document.getElementById('aiStatus').textContent = data.components?.llm_analysis ? 'Online' : 'Offline';

                // Update camera grid
                this.updateCameraGrid(data.components || {});
            }

            updateRiskAssessment(riskData) {
                if (!riskData) return;

                const riskLevel = riskData.pharmacy_risk_level || 'UNKNOWN';
                const riskScore = riskData.pharmacy_risk_score || 0;
                const activePeople = riskData.total_active_people || 0;

                // Update threat status
                const threatCard = document.getElementById('threatStatus');
                threatCard.className = `status-card ${riskLevel.toLowerCase()}`;
                
                const riskLevelElement = document.getElementById('riskLevel');
                riskLevelElement.textContent = riskLevel;
                riskLevelElement.className = `threat-level ${riskLevel.toLowerCase()}`;
                
                document.getElementById('activePeople').textContent = activePeople;
                document.getElementById('riskScore').textContent = (riskScore * 100).toFixed(1) + '%';
                
                // Update threat indicator
                const indicator = document.getElementById('threatIndicator');
                if (riskLevel === 'CRITICAL' || riskLevel === 'HIGH') {
                    indicator.className = 'status-indicator offline';
                } else if (riskLevel === 'MEDIUM') {
                    indicator.className = 'status-indicator warning';
                } else {
                    indicator.className = 'status-indicator';
                }
            }

            updateEvents(events) {
                document.getElementById('totalEvents').textContent = events.length;
                
                const confirmedThreats = events.filter(e => e.confirmed_suspicious === true).length;
                const falsePositives = events.filter(e => e.confirmed_suspicious === false).length;
                const avgProcessing = events.length > 0 ? 
                    (events.reduce((sum, e) => sum + (e.processing_time || 0), 0) / events.length).toFixed(2) : 0;

                document.getElementById('confirmedThreats').textContent = confirmedThreats;
                document.getElementById('falsePositives').textContent = falsePositives;
                document.getElementById('averageResponse').textContent = avgProcessing;

                // Update camera detection status
                this.updateCameraDetectionStatus(events);

                // Update events list
                const container = document.getElementById('eventsContainer');
                if (events.length === 0) {
                    container.innerHTML = `
                        <div class="event-item">
                            <div class="event-info">
                                <div class="event-type">No recent events</div>
                                <div class="event-details">System monitoring for suspicious activities...</div>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = events.slice(0, 10).map(event => `
                        <div class="event-item">
                            <div class="event-info">
                                <div class="event-type">${this.formatActivityType(event.activity_type)}</div>
                                <div class="event-details">
                                    Camera ${event.camera_id} ‚Ä¢ Confidence: ${(event.confidence * 100).toFixed(1)}%
                                    ${event.recording_created ? ' ‚Ä¢ üìπ Recorded' : ''}
                                </div>
                                <div class="event-time">${this.formatTime(event.timestamp)}</div>
                            </div>
                            <div class="threat-level ${event.threat_level.toLowerCase()}">${event.threat_level}</div>
                        </div>
                    `).join('');
                }
            }

            updateRecordingStatus(data) {
                const activeCount = data.count || 0;
                document.getElementById('activeRecordings').textContent = activeCount;
                document.getElementById('activeRecordingCount').textContent = activeCount;
                
                const recordingInfo = document.getElementById('recordingInfo');
                recordingInfo.className = `recording-status ${activeCount > 0 ? 'recording-active' : ''}`;
                document.getElementById('recordingStatusText').textContent = activeCount > 0 ? 'Recording' : 'Ready';
            }

            updateWebhookStatus(data) {
                if (!data.success) return;

                const stats = data.webhook_statistics;
                document.getElementById('webhooksOnline').textContent = stats.enabled_webhooks || 0;
                document.getElementById('alertsSent').textContent = stats.successful_deliveries || 0;
                document.getElementById('alertSuccessRate').textContent = 
                    ((stats.success_rate || 0) * 100).toFixed(1) + '%';

                // Update webhook list
                const container = document.getElementById('webhookContainer');
                const webhookPerf = stats.webhook_performance || {};
                
                if (Object.keys(webhookPerf).length === 0) {
                    container.innerHTML = `
                        <div class="webhook-status">
                            <span>No webhooks configured</span>
                            <span>‚ûñ</span>
                        </div>
                    `;
                } else {
                    container.innerHTML = Object.entries(webhookPerf).map(([name, perf]) => `
                        <div class="webhook-status ${perf.success_rate > 0.8 ? 'webhook-online' : 'webhook-offline'}">
                            <span>${name}</span>
                            <span>${(perf.success_rate * 100).toFixed(0)}%</span>
                        </div>
                    `).join('');
                }
            }

            updateCameraGrid(components) {
                const grid = document.getElementById('cameraGrid');
                const cameras = [1, 2, 3, 4];
                
                grid.innerHTML = cameras.map(id => {
                    const isActive = components.activity_detection;
                    return `
                        <div class="camera-card ${isActive ? 'camera-active' : ''}">
                            Camera ${id}<br>
                            <small>${isActive ? 'Active' : 'Offline'}</small>
                        </div>
                    `;
                }).join('');
            }

            initializeCameraSection() {
                // Initialize camera status indicators
                for (let i = 1; i <= 4; i++) {
                    const statusElement = document.getElementById(`cameraStatus${i}`);
                    const feedElement = document.getElementById(`liveCamera${i}`);
                    if (statusElement && feedElement) {
                        statusElement.className = 'camera-status';
                        feedElement.className = 'camera-feed active';
                    }
                }

                // Add toggle functionality
                const toggleButton = document.getElementById('toggleCamerasButton');
                if (toggleButton) {
                    toggleButton.addEventListener('click', () => this.toggleCameraVisibility());
                }

                // Add click handlers for full-screen view
                for (let i = 1; i <= 4; i++) {
                    const feedElement = document.getElementById(`liveCamera${i}`);
                    if (feedElement) {
                        feedElement.addEventListener('click', () => this.openCameraFullscreen(i));
                        feedElement.style.cursor = 'pointer';
                    }
                }
            }

            toggleCameraVisibility() {
                const cameraSection = document.querySelector('.live-cameras-section');
                const toggleButton = document.getElementById('toggleCamerasButton');
                
                this.camerasVisible = !this.camerasVisible;
                
                if (this.camerasVisible) {
                    cameraSection.style.display = 'block';
                    toggleButton.textContent = 'üìπ Hide Cameras';
                    this.addLog('Camera feeds shown', 'info');
                    // Restart streaming when showing cameras
                    this.startAllStreams();
                } else {
                    cameraSection.style.display = 'none';
                    toggleButton.textContent = 'üìπ Show Cameras';
                    this.addLog('Camera feeds hidden', 'info');
                    // Stop streaming when hiding cameras to save bandwidth
                    if (this.streamWs && this.streamWs.readyState === WebSocket.OPEN) {
                        for (let cameraId = 1; cameraId <= 4; cameraId++) {
                            this.streamWs.send(JSON.stringify({
                                type: 'stop_stream',
                                camera_id: cameraId
                            }));
                        }
                    }
                }
            }

            openCameraFullscreen(cameraId) {
                // Open streaming dashboard focused on specific camera
                window.open(`/streaming-dashboard?camera=${cameraId}`, '_blank');
                this.addLog(`Opening Camera ${cameraId} in full screen`, 'info');
            }

            updateCameraDetectionStatus(events) {
                // Reset all detection states
                for (let i = 1; i <= 4; i++) {
                    this.detectionStates[i] = false;
                }

                // Check recent events for camera activity
                const currentTime = Date.now() / 1000;
                events.forEach(event => {
                    if (currentTime - event.timestamp < 30) { // Last 30 seconds
                        this.detectionStates[event.camera_id] = true;
                    }
                });

                // Update UI
                for (let i = 1; i <= 4; i++) {
                    this.updateCameraFeed(i, this.detectionStates[i]);
                }
            }

            updateCameraFeed(cameraId, isDetecting) {
                const feedElement = document.getElementById(`liveCamera${cameraId}`);
                const statusElement = document.getElementById(`cameraStatus${cameraId}`);
                const overlayElement = document.getElementById(`detectionOverlay${cameraId}`);

                if (!feedElement || !statusElement || !overlayElement) return;

                if (isDetecting) {
                    feedElement.className = 'camera-feed active detecting';
                    statusElement.className = 'camera-status detecting';
                    overlayElement.className = 'detection-overlay visible';
                } else {
                    feedElement.className = 'camera-feed active';
                    statusElement.className = 'camera-status';
                    overlayElement.className = 'detection-overlay';
                }
            }

            formatActivityType(type) {
                return type.split('_').map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ');
            }

            formatTime(timestamp) {
                return new Date(timestamp * 1000).toLocaleTimeString();
            }

            addLog(message, level = 'info') {
                const log = document.getElementById('systemLog');
                const time = new Date().toLocaleTimeString();
                const entry = document.createElement('div');
                entry.className = `log-entry log-${level}`;
                entry.textContent = `[${time}] ${message}`;
                log.appendChild(entry);
                log.scrollTop = log.scrollHeight;

                // Keep only last 20 entries to prevent infinite growth
                while (log.children.length > 20) {
                    log.removeChild(log.firstChild);
                }
            }

            async processAllFrames() {
                this.addLog('Processing frames from all cameras...', 'info');
                
                for (let cameraId = 1; cameraId <= 4; cameraId++) {
                    try {
                        const response = await fetch(`/security/process-frame?camera_id=${cameraId}`, {
                            method: 'POST'
                        });
                        const data = await response.json();
                        
                        if (data.success && data.activities_detected > 0) {
                            this.addLog(`Camera ${cameraId}: ${data.activities_detected} activities detected`, 'warning');
                        }
                    } catch (error) {
                        this.addLog(`Camera ${cameraId}: Error processing frame`, 'error');
                    }
                }
                
                // Refresh status after processing
                setTimeout(() => this.refreshStatus(), 1000);
            }

            async testWebhooks() {
                this.addLog('Testing webhook endpoints...', 'info');
                
                try {
                    const response = await fetch('/webhooks/test', { method: 'POST' });
                    const data = await response.json();
                    
                    if (data.success) {
                        this.addLog(`Webhook test: ${data.successful_deliveries}/${data.total_webhooks} successful`, 'info');
                    } else {
                        this.addLog('Webhook test failed: ' + data.message, 'error');
                    }
                } catch (error) {
                    this.addLog('Webhook test error: ' + error.message, 'error');
                }
            }

            viewRecordings() {
                window.open('/recordings/history', '_blank');
            }

            addWebhook() {
                const name = prompt('Webhook name:');
                const url = prompt('Webhook URL:');
                
                if (name && url) {
                    fetch('/webhooks/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, url, enabled: true })
                    }).then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            this.addLog(`Webhook '${name}' added successfully`, 'info');
                            this.refreshStatus();
                        } else {
                            this.addLog('Failed to add webhook: ' + data.message, 'error');
                        }
                    });
                }
            }

            cleanupOldRecordings() {
                if (confirm('Delete recordings older than 30 days?')) {
                    this.addLog('Cleaning up old recordings...', 'info');
                    // This would call a cleanup endpoint
                }
            }
        }

        // Global functions for buttons
        let dashboard;

        function refreshStatus() {
            dashboard.refreshStatus();
        }

        function processAllFrames() {
            dashboard.processAllFrames();
        }

        function testWebhooks() {
            dashboard.testWebhooks();
        }

        function simulateDetection() {
            // Simulate detection on random camera for testing
            const randomCamera = Math.floor(Math.random() * 4) + 1;
            dashboard.updateCameraFeed(randomCamera, true);
            dashboard.addLog(`Simulated detection on Camera ${randomCamera}`, 'warning');
            
            // Reset after 5 seconds
            setTimeout(() => {
                dashboard.updateCameraFeed(randomCamera, false);
                dashboard.addLog(`Detection cleared on Camera ${randomCamera}`, 'info');
            }, 5000);
        }

        function viewRecordings() {
            dashboard.viewRecordings();
        }

        function addWebhook() {
            dashboard.addWebhook();
        }

        function cleanupOldRecordings() {
            dashboard.cleanupOldRecordings();
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            dashboard = new SecurityDashboard();
        });
    </script>
</body>
</html>

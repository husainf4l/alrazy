/**
 * Room Designer - Main Application
 * Initializes and coordinates all modules
 */

// Global state reference for external access
window.roomDesignerState = null;

/**
 * Initialize the room designer application
 */
function initRoomDesigner(roomId) {
    console.log('Initializing Room Designer for room:', roomId);
    
    const canvas = document.getElementById('designCanvas');
    if (!canvas) {
        console.error('Canvas element not found');
        return;
    }
    
    console.log('Canvas found:', canvas, 'Size:', canvas.width, 'x', canvas.height);
    
    // Initialize state
    RoomDesignerState.init(canvas, roomId);
    window.roomDesignerState = RoomDesignerState;
    
    console.log('State initialized, context:', RoomDesignerState.ctx);
    
    // Resize canvas to fill container
    function resizeCanvas() {
        const container = canvas.parentElement;
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        RoomDesignerState.panOffset = { 
            x: canvas.width / 2, 
            y: canvas.height / 2 
        };
        console.log('Canvas resized to:', canvas.width, 'x', canvas.height);
        RoomDesignerRenderer.render(RoomDesignerState);
    }
    
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    
    // Initialize event handlers
    console.log('Initializing events...');
    RoomDesignerEvents.init(RoomDesignerState);
    
    // Initialize action buttons
    console.log('Initializing action buttons...');
    initActionButtons();
    
    // Load room data
    console.log('Loading room data...');
    RoomDesignerAPI.loadRoomData(roomId, RoomDesignerState);
    
    // Show helper message
    showHelper();
    
    console.log('Room Designer initialized successfully');
}

/**
 * Initialize action buttons
 */
function initActionButtons() {
    const state = RoomDesignerState;
    
    // Auto-generate zones from cameras
    document.getElementById('autoGenerateZones')?.addEventListener('click', () => {
        // Remove existing auto-generated zones
        state.objects = state.objects.filter(obj => !(obj.type === 'zone' && obj.autoGenerated));
        
        // Generate new zones from cameras
        const generatedZones = RoomDesignerUtils.autoGenerateZonesFromCameras(state.objects);
        
        // Add generated zones to objects
        state.objects.push(...generatedZones);
        
        // Save to history
        state.saveToHistory();
        
        // Render
        RoomDesignerRenderer.render(state);
        
        // Show status message
        const statusMsg = document.getElementById('statusMsg');
        if (statusMsg) {
            statusMsg.textContent = `Generated ${generatedZones.length} zones from cameras`;
        }
        
        console.log('Auto-generated zones:', generatedZones);
    });
    
    // Save design
    document.getElementById('saveDesign')?.addEventListener('click', () => {
        RoomDesignerAPI.saveDesign(state);
    });
    
    // Export design
    document.getElementById('exportPNG')?.addEventListener('click', () => {
        RoomDesignerAPI.exportDesign(state);
    });
    
    // Load design
    document.getElementById('loadDesign')?.addEventListener('click', () => {
        RoomDesignerAPI.importDesign(state);
    });
    
    // Scale input
    document.getElementById('scale')?.addEventListener('change', (e) => {
        state.scale = parseFloat(e.target.value) || 20;
        RoomDesignerRenderer.render(state);
    });
    
    // Grid size input
    document.getElementById('gridSize')?.addEventListener('change', (e) => {
        state.gridSize = parseFloat(e.target.value) || 1;
        RoomDesignerRenderer.render(state);
    });
    
    // Zoom to fit button
    document.getElementById('zoomFit')?.addEventListener('click', () => {
        RoomDesignerUtils.zoomToFit(state);
    });
    
    // Ribbon tab switching
    document.querySelectorAll('.ribbon-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            if (!tabName) return;
            
            // Remove active class from all tabs
            document.querySelectorAll('.ribbon-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            // Hide all content sections
            document.querySelectorAll('.ribbon-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Show selected content
            const contentId = `ribbon-${tabName}`;
            const content = document.getElementById(contentId);
            if (content) {
                content.style.display = 'flex';
            }
        });
    });
    
    // Layer visibility toggles
    document.querySelectorAll('.layer-item').forEach(layerItem => {
        layerItem.addEventListener('click', (e) => {
            if (e.target.closest('.layer-visibility')) {
                const layer = layerItem.dataset.layer;
                if (layer && state.layers.hasOwnProperty(layer)) {
                    state.layers[layer] = !state.layers[layer];
                    layerItem.classList.toggle('active', state.layers[layer]);
                    
                    const icon = layerItem.querySelector('.layer-visibility i');
                    if (icon) {
                        icon.className = state.layers[layer] ? 'fas fa-eye' : 'fas fa-eye-slash';
                    }
                    
                    RoomDesignerRenderer.render(state);
                    
                    const statusMsg = document.getElementById('statusMsg');
                    if (statusMsg) {
                        const visibility = state.layers[layer] ? 'shown' : 'hidden';
                        statusMsg.textContent = `${layer.charAt(0).toUpperCase() + layer.slice(1)} layer ${visibility}`;
                    }
                }
            }
        });
    });
}

/**
 * Show helper message
 */
function showHelper() {
    const helper = document.createElement('div');
    helper.style.cssText = `
        position: fixed;
        bottom: 60px;
        right: 20px;
        background: rgba(0, 120, 215, 0.95);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        font-size: 13px;
        z-index: 1000;
        max-width: 350px;
    `;
    
    helper.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 8px;">
            <i class="fas fa-info-circle"></i> Room Designer Controls
        </div>
        <div style="line-height: 1.6; margin-bottom: 10px;">
            <b>üìê Workflow:</b><br>
            1. Draw <b>Walls</b> to create room layout<br>
            2. Place <b>Cameras</b> from the list<br>
            3. Draw <b>Zones</b> (camera coverage areas)<br>
            4. System detects overlapping coverage
        </div>
        <div style="border-top: 1px solid rgba(255,255,255,0.3); padding-top: 8px; margin-top: 8px;">
            <b>üéØ What are Zones?</b><br>
            Zones show camera coverage areas:<br>
            ‚Ä¢ <span style="color: #ff00ff;">‚ñ†</span> MAGENTA = Normal coverage<br>
            ‚Ä¢ <span style="color: #ff6400;">‚ñ†</span> ORANGE = Overlapping<br>
            ‚Ä¢ <span style="color: #dd00ff;">‚ñ†</span> PURPLE = Overlap area (m¬≤)
        </div>
        <div style="border-top: 1px solid rgba(255,255,255,0.3); padding-top: 8px; margin-top: 8px; font-size: 11px;">
            <b>‚å®Ô∏è Shortcuts:</b><br>
            ‚Ä¢ <b>ESC:</b> Cancel/Deselect<br>
            ‚Ä¢ <b>Delete/Backspace:</b> Remove selected<br>
            ‚Ä¢ <b>Ctrl+Z:</b> Undo | <b>Ctrl+Y:</b> Redo<br>
            ‚Ä¢ <b>Mouse Wheel:</b> Zoom
        </div>
    `;
    
    document.body.appendChild(helper);
    
    // Auto-hide after 12 seconds
    setTimeout(() => {
        helper.style.transition = 'opacity 0.5s';
        helper.style.opacity = '0';
        setTimeout(() => helper.remove(), 500);
    }, 12000);
}

// Auto-initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        const roomId = window.ROOM_ID;
        if (roomId) {
            initRoomDesigner(roomId);
        }
    });
} else {
    const roomId = window.ROOM_ID;
    if (roomId) {
        initRoomDesigner(roomId);
    }
}

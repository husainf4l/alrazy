<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAZZ Room Designer - Professional CAD</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #0a0a0a;
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }

        /* AutoCAD Color Scheme */
        :root {
            --bg-dark: #0a0a0a;
            --bg-ui: #2d2d2d;
            --bg-ui-hover: #3d3d3d;
            --border: #4a4a4a;
            --accent-blue: #0078d7;
            --accent-cyan: #00ffff;
            --accent-yellow: #ffff00;
            --grid-color: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #999999;
        }

        /* Top Ribbon (AutoCAD Style) */
        .ribbon {
            background: linear-gradient(180deg, #3d3d3d 0%, var(--bg-ui) 100%);
            border-bottom: 2px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .ribbon-tabs {
            display: flex;
            background: #252525;
            border-bottom: 1px solid var(--border);
        }

        .ribbon-tab {
            padding: 10px 24px;
            cursor: pointer;
            border-right: 1px solid var(--border);
            transition: all 0.2s;
            font-size: 13px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ribbon-tab:hover {
            background: var(--bg-ui-hover);
        }

        .ribbon-tab.active {
            background: var(--accent-blue);
            color: white;
            box-shadow: inset 0 -3px 0 #fff;
        }

        .ribbon-content {
            display: flex;
            padding: 12px 20px;
            gap: 25px;
            min-height: 100px;
        }

        .ribbon-group {
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
            padding-right: 25px;
        }

        .ribbon-group:last-child {
            border-right: none;
        }

        .ribbon-group-title {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        .ribbon-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .ribbon-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 16px;
            background: var(--bg-ui-hover);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 4px;
            min-width: 75px;
        }

        .ribbon-button:hover {
            background: #4d4d4d;
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .ribbon-button.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            box-shadow: 0 0 15px rgba(0, 120, 215, 0.6);
        }

        .ribbon-button i {
            font-size: 28px;
            margin-bottom: 6px;
        }

        .ribbon-button span {
            font-size: 11px;
            font-weight: 500;
        }

        /* Left Toolbar */
        .left-toolbar {
            position: fixed;
            left: 0;
            top: 152px;
            bottom: 32px;
            width: 90px;
            background: var(--bg-ui);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 12px 8px;
            gap: 8px;
            overflow-y: auto;
            z-index: 100;
        }

        .tool-button {
            width: 74px;
            height: 74px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-ui-hover);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 4px;
            position: relative;
        }

        .tool-button:hover {
            background: #4d4d4d;
            border-color: var(--accent-blue);
            transform: scale(1.05);
        }

        .tool-button.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            box-shadow: 0 0 15px rgba(0, 120, 215, 0.7);
        }

        .tool-button i {
            font-size: 32px;
            margin-bottom: 6px;
        }

        .tool-button span {
            font-size: 10px;
            text-align: center;
            line-height: 1.2;
        }

        .tool-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #ff4444;
            color: white;
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 10px;
            font-weight: bold;
        }

        /* Right Properties Panel */
        .properties-panel {
            position: fixed;
            right: 0;
            top: 152px;
            bottom: 32px;
            width: 320px;
            background: var(--bg-ui);
            border-left: 1px solid var(--border);
            overflow-y: auto;
            z-index: 100;
        }

        .properties-header {
            padding: 15px;
            background: #252525;
            border-bottom: 2px solid var(--border);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .property-section {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }

        .property-section-title {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--accent-blue);
            margin-bottom: 12px;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .property-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .property-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .property-input {
            background: #1a1a1a;
            border: 1px solid var(--border);
            padding: 6px 12px;
            width: 140px;
            color: white;
            font-size: 12px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        .property-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 8px rgba(0, 120, 215, 0.5);
        }

        .property-color {
            width: 40px;
            height: 30px;
            border: 1px solid var(--border);
            cursor: pointer;
            border-radius: 3px;
        }

        .property-button {
            width: 100%;
            padding: 10px;
            background: var(--accent-blue);
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 3px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 1px;
            transition: all 0.2s;
        }

        .property-button:hover {
            background: #0066c0;
            box-shadow: 0 4px 12px rgba(0, 120, 215, 0.4);
        }

        .property-button.danger {
            background: #d32f2f;
        }

        .property-button.danger:hover {
            background: #b71c1c;
        }

        /* Canvas Container */
        .canvas-container {
            position: fixed;
            left: 90px;
            right: 320px;
            top: 152px;
            bottom: 32px;
            background: var(--bg-dark);
            overflow: hidden;
        }

        #canvas {
            cursor: crosshair;
            display: block;
        }

        /* Status Bar */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 32px;
            background: #252525;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 25px;
            font-size: 12px;
            z-index: 100;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-item.coordinates {
            font-family: 'Courier New', monospace;
            color: var(--accent-cyan);
            font-weight: 600;
            min-width: 200px;
        }

        .snap-button {
            padding: 4px 12px;
            background: var(--bg-ui);
            border: 1px solid var(--border);
            cursor: pointer;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .snap-button:hover {
            background: var(--bg-ui-hover);
        }

        .snap-button.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            box-shadow: 0 0 8px rgba(0, 120, 215, 0.5);
        }

        /* Layers Panel */
        .layer-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #1a1a1a;
            border: 1px solid var(--border);
            margin-bottom: 6px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .layer-item:hover {
            background: #2a2a2a;
            border-color: var(--accent-blue);
        }

        .layer-item.active {
            border-color: var(--accent-blue);
            box-shadow: 0 0 10px rgba(0, 120, 215, 0.3);
        }

        .layer-visibility {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--accent-cyan);
        }

        .layer-color {
            width: 35px;
            height: 24px;
            border: 1px solid var(--border);
            cursor: pointer;
            border-radius: 3px;
        }

        .layer-name {
            flex: 1;
            font-size: 12px;
            font-weight: 500;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--bg-ui);
            border: 1px solid var(--border);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.8);
            border-radius: 4px;
            min-width: 200px;
            z-index: 10000;
            display: none;
        }

        .context-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
        }

        .context-menu-item:hover {
            background: var(--accent-blue);
        }

        .context-menu-item i {
            width: 20px;
            text-align: center;
        }

        .context-menu-divider {
            height: 1px;
            background: var(--border);
            margin: 6px 0;
        }

        /* Measurement Tooltip */
        .measurement-tooltip {
            position: absolute;
            background: rgba(0, 120, 215, 0.95);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            pointer-events: none;
            z-index: 1000;
            font-family: 'Courier New', monospace;
        }

        /* Grid Toggle */
        .grid-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-switch {
            width: 40px;
            height: 20px;
            background: #555;
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: var(--accent-blue);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }

        .toggle-switch.active::after {
            left: 22px;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid var(--accent-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-blue);
        }

        /* Camera Icon Styling */
        .camera-icon {
            fill: var(--accent-cyan);
            stroke: #fff;
            stroke-width: 2;
        }

        .camera-fov {
            fill: rgba(0, 255, 255, 0.2);
            stroke: var(--accent-cyan);
            stroke-width: 1;
            stroke-dasharray: 5, 5;
        }

        /* Wall Styling */
        .wall-line {
            stroke: #ffffff;
            stroke-width: 4;
            stroke-linecap: round;
        }

        /* Zone Styling */
        .zone-area {
            fill: rgba(255, 0, 255, 0.15);
            stroke: #ff00ff;
            stroke-width: 2;
            stroke-dasharray: 8, 4;
        }

        /* Selection Box */
        .selection-box {
            fill: rgba(0, 120, 215, 0.1);
            stroke: var(--accent-blue);
            stroke-width: 1;
            stroke-dasharray: 4, 4;
        }

        /* Helper Text */
        .helper-text {
            position: fixed;
            top: 170px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 120, 215, 0.95);
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            z-index: 200;
            display: none;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -10px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        /* Mini Map */
        .mini-map {
            position: absolute;
            bottom: 50px;
            right: 340px;
            width: 200px;
            height: 150px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            bottom: 220px;
            right: 340px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .zoom-button {
            width: 40px;
            height: 40px;
            background: var(--bg-ui);
            border: 1px solid var(--border);
            color: white;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }

        .zoom-button:hover {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }

        .zoom-level {
            width: 40px;
            height: 40px;
            background: var(--bg-ui);
            border: 1px solid var(--border);
            color: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <!-- Helper Text -->
    <div id="helperText" class="helper-text"></div>

    <!-- Top Ribbon -->
    <div class="ribbon">
        <div class="ribbon-tabs">
            <div class="ribbon-tab active" data-tab="draw">Draw</div>
            <div class="ribbon-tab" data-tab="modify">Modify</div>
            <div class="ribbon-tab" data-tab="camera">Cameras</div>
            <div class="ribbon-tab" data-tab="layers">Layers</div>
            <div class="ribbon-tab" data-tab="view">View</div>
        </div>
        <div class="ribbon-content">
            <!-- Draw Tab -->
            <div id="draw-panel" class="ribbon-panel">
                <div class="ribbon-group">
                    <div class="ribbon-group-title">Walls</div>
                    <div class="ribbon-buttons">
                        <div class="ribbon-button" data-tool="wall">
                            <i class="fas fa-minus"></i>
                            <span>Wall</span>
                        </div>
                        <div class="ribbon-button" data-tool="rectangle">
                            <i class="far fa-square"></i>
                            <span>Rectangle</span>
                        </div>
                    </div>
                </div>
                <div class="ribbon-group">
                    <div class="ribbon-group-title">Doors & Windows</div>
                    <div class="ribbon-buttons">
                        <div class="ribbon-button" data-tool="door">
                            <i class="fas fa-door-open"></i>
                            <span>Door</span>
                        </div>
                        <div class="ribbon-button" data-tool="window">
                            <i class="fas fa-th-large"></i>
                            <span>Window</span>
                        </div>
                    </div>
                </div>
                <div class="ribbon-group">
                    <div class="ribbon-group-title">Zones</div>
                    <div class="ribbon-buttons">
                        <div class="ribbon-button" data-tool="zone">
                            <i class="fas fa-draw-polygon"></i>
                            <span>Zone</span>
                        </div>
                        <div class="ribbon-button" data-tool="entry">
                            <i class="fas fa-sign-in-alt"></i>
                            <span>Entry</span>
                        </div>
                    </div>
                </div>
                <div class="ribbon-group">
                    <div class="ribbon-group-title">Measure</div>
                    <div class="ribbon-buttons">
                        <div class="ribbon-button" data-tool="measure">
                            <i class="fas fa-ruler"></i>
                            <span>Measure</span>
                        </div>
                        <div class="ribbon-button" data-tool="dimension">
                            <i class="fas fa-arrows-alt-h"></i>
                            <span>Dimension</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Left Toolbar -->
    <div class="left-toolbar">
        <div class="tool-button active" data-tool="select" title="Select (Esc)">
            <i class="fas fa-mouse-pointer"></i>
            <span>Select</span>
        </div>
        <div class="tool-button" data-tool="wall" title="Draw Wall (W)">
            <i class="fas fa-minus"></i>
            <span>Wall</span>
        </div>
        <div class="tool-button" data-tool="door" title="Add Door (D)">
            <i class="fas fa-door-open"></i>
            <span>Door</span>
        </div>
        <div class="tool-button" data-tool="camera" title="Place Camera (C)">
            <i class="fas fa-video"></i>
            <span>Camera</span>
            <span class="tool-badge">AI</span>
        </div>
        <div class="tool-button" data-tool="zone" title="Draw Zone (Z)">
            <i class="fas fa-draw-polygon"></i>
            <span>Zone</span>
        </div>
        <div class="tool-button" data-tool="text" title="Add Text (T)">
            <i class="fas fa-font"></i>
            <span>Text</span>
        </div>
        <div class="tool-button" data-tool="measure" title="Measure (M)">
            <i class="fas fa-ruler"></i>
            <span>Measure</span>
        </div>
        <div class="tool-button" data-tool="pan" title="Pan View (P)">
            <i class="fas fa-hand-paper"></i>
            <span>Pan</span>
        </div>
    </div>

    <!-- Canvas Container -->
    <div class="canvas-container">
        <canvas id="canvas"></canvas>
        
        <!-- Zoom Controls -->
        <div class="zoom-controls">
            <div class="zoom-button" id="zoomIn" title="Zoom In">
                <i class="fas fa-plus"></i>
            </div>
            <div class="zoom-level" id="zoomLevel">100%</div>
            <div class="zoom-button" id="zoomOut" title="Zoom Out">
                <i class="fas fa-minus"></i>
            </div>
            <div class="zoom-button" id="zoomFit" title="Zoom to Fit">
                <i class="fas fa-expand"></i>
            </div>
        </div>
    </div>

    <!-- Right Properties Panel -->
    <div class="properties-panel">
        <div class="properties-header">
            <i class="fas fa-sliders-h"></i> PROPERTIES
        </div>
        
        <!-- General Properties -->
        <div class="property-section" id="generalProps">
            <div class="property-section-title">General</div>
            <div class="property-row">
                <span class="property-label">Room Name</span>
                <input type="text" class="property-input" id="roomName" value="Office">
            </div>
            <div class="property-row">
                <span class="property-label">Scale (px/m)</span>
                <input type="number" class="property-input" id="scale" value="20">
            </div>
            <div class="property-row">
                <span class="property-label">Grid Size (m)</span>
                <input type="number" class="property-input" id="gridSize" value="1" step="0.5">
            </div>
        </div>

        <!-- Selection Properties -->
        <div class="property-section" id="selectionProps" style="display: none;">
            <div class="property-section-title">Selected Object</div>
            <div class="property-row">
                <span class="property-label">Type</span>
                <input type="text" class="property-input" id="objType" readonly>
            </div>
            <div class="property-row">
                <span class="property-label">X Position</span>
                <input type="number" class="property-input" id="objX" step="0.1">
            </div>
            <div class="property-row">
                <span class="property-label">Y Position</span>
                <input type="number" class="property-input" id="objY" step="0.1">
            </div>
            <div class="property-row">
                <span class="property-label">Color</span>
                <input type="color" class="property-color" id="objColor" value="#ffffff">
            </div>
            <button class="property-button danger" id="deleteObj">
                <i class="fas fa-trash"></i> Delete Object
            </button>
        </div>

        <!-- Camera Properties -->
        <div class="property-section" id="cameraProps" style="display: none;">
            <div class="property-section-title">Camera Settings</div>
            <div class="property-row">
                <span class="property-label">Camera ID</span>
                <input type="number" class="property-input" id="cameraId">
            </div>
            <div class="property-row">
                <span class="property-label">Angle (deg)</span>
                <input type="number" class="property-input" id="cameraAngle" value="0" step="15">
            </div>
            <div class="property-row">
                <span class="property-label">FOV (deg)</span>
                <input type="number" class="property-input" id="cameraFOV" value="90" step="10">
            </div>
            <div class="property-row">
                <span class="property-label">Range (m)</span>
                <input type="number" class="property-input" id="cameraRange" value="10" step="1">
            </div>
            <button class="property-button" id="testCamera">
                <i class="fas fa-play"></i> Test Camera
            </button>
        </div>

        <!-- Layers -->
        <div class="property-section">
            <div class="property-section-title">Layers</div>
            <div class="layer-item active" data-layer="walls">
                <div class="layer-visibility"><i class="fas fa-eye"></i></div>
                <div class="layer-color" style="background: #ffffff;"></div>
                <div class="layer-name">Walls</div>
            </div>
            <div class="layer-item" data-layer="doors">
                <div class="layer-visibility"><i class="fas fa-eye"></i></div>
                <div class="layer-color" style="background: #8b4513;"></div>
                <div class="layer-name">Doors</div>
            </div>
            <div class="layer-item" data-layer="cameras">
                <div class="layer-visibility"><i class="fas fa-eye"></i></div>
                <div class="layer-color" style="background: #00ffff;"></div>
                <div class="layer-name">Cameras</div>
            </div>
            <div class="layer-item" data-layer="zones">
                <div class="layer-visibility"><i class="fas fa-eye"></i></div>
                <div class="layer-color" style="background: #ff00ff;"></div>
                <div class="layer-name">Zones</div>
            </div>
        </div>

        <!-- Actions -->
        <div class="property-section">
            <div class="property-section-title">Actions</div>
            <button class="property-button" id="saveDesign">
                <i class="fas fa-save"></i> Save Design
            </button>
            <button class="property-button" id="loadDesign" style="background: #666; margin-top: 8px;">
                <i class="fas fa-folder-open"></i> Load Design
            </button>
            <button class="property-button" id="exportPNG" style="background: #666; margin-top: 8px;">
                <i class="fas fa-download"></i> Export as PNG
            </button>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-item coordinates">
            <i class="fas fa-crosshairs"></i>
            <span id="coords">X: 0.00, Y: 0.00</span>
        </div>
        <div class="status-item">
            <span class="snap-button active" id="snapGrid" title="Snap to Grid">
                <i class="fas fa-th"></i> GRID
            </span>
        </div>
        <div class="status-item">
            <span class="snap-button" id="snapObject" title="Snap to Objects">
                <i class="fas fa-magnet"></i> OSNAP
            </span>
        </div>
        <div class="status-item">
            <span class="snap-button" id="orthoMode" title="Orthogonal Mode">
                <i class="fas fa-arrows-alt"></i> ORTHO
            </span>
        </div>
        <div class="status-item grid-toggle">
            <span>Show Grid</span>
            <div class="toggle-switch active" id="gridToggle"></div>
        </div>
        <div class="status-item" style="margin-left: auto;">
            <i class="fas fa-info-circle"></i>
            <span id="statusMsg">Ready</span>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" data-action="properties">
            <i class="fas fa-info-circle"></i>
            <span>Properties</span>
        </div>
        <div class="context-menu-item" data-action="duplicate">
            <i class="fas fa-copy"></i>
            <span>Duplicate</span>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" data-action="delete">
            <i class="fas fa-trash"></i>
            <span>Delete</span>
        </div>
    </div>

    <script>
        // Canvas Setup
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // State
        let currentTool = 'select';
        let isDrawing = false;
        let startPoint = null;
        let objects = [];
        let selectedObject = null;
        let scale = 20; // pixels per meter
        let gridSize = 1; // meters
        let showGrid = true;
        let snapToGrid = true;
        let orthoMode = false;
        let zoom = 1;
        let panOffset = { x: 0, y: 0 };
        let isPanning = false;
        let lastPanPoint = null;

        // Resize canvas to fill container
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            render();
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Grid Drawing
        function drawGrid() {
            if (!showGrid) return;
            
            ctx.save();
            ctx.strokeStyle = '#1a1a1a';
            ctx.lineWidth = 1;
            
            const gridPixels = gridSize * scale * zoom;
            const startX = panOffset.x % gridPixels;
            const startY = panOffset.y % gridPixels;
            
            // Vertical lines
            for (let x = startX; x < canvas.width; x += gridPixels) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            // Horizontal lines
            for (let y = startY; y < canvas.height; y += gridPixels) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            // Draw origin
            const originX = panOffset.x;
            const originY = panOffset.y;
            
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(originX - 10, originY);
            ctx.lineTo(originX + 10, originY);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(originX, originY - 10);
            ctx.lineTo(originX, originY + 10);
            ctx.stroke();
            
            ctx.restore();
        }

        // Transform screen coords to world coords
        function screenToWorld(screenX, screenY) {
            return {
                x: (screenX - panOffset.x) / (scale * zoom),
                y: (screenY - panOffset.y) / (scale * zoom)
            };
        }

        // Transform world coords to screen coords
        function worldToScreen(worldX, worldY) {
            return {
                x: worldX * scale * zoom + panOffset.x,
                y: worldY * scale * zoom + panOffset.y
            };
        }

        // Snap to grid
        function snapPoint(point) {
            if (!snapToGrid) return point;
            
            const snapped = {
                x: Math.round(point.x / gridSize) * gridSize,
                y: Math.round(point.y / gridSize) * gridSize
            };
            return snapped;
        }

        // Render all objects
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            drawGrid();
            
            // Draw objects
            objects.forEach(obj => {
                if (obj.type === 'wall') {
                    drawWall(obj);
                } else if (obj.type === 'camera') {
                    drawCamera(obj);
                } else if (obj.type === 'zone') {
                    drawZone(obj);
                }
            });
            
            // Draw selection
            if (selectedObject) {
                highlightObject(selectedObject);
            }
        }

        // Draw wall
        function drawWall(wall) {
            const start = worldToScreen(wall.start.x, wall.start.y);
            const end = worldToScreen(wall.end.x, wall.end.y);
            
            ctx.save();
            ctx.strokeStyle = wall.color || '#ffffff';
            ctx.lineWidth = 4;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(start.x, start.y);
            ctx.lineTo(end.x, end.y);
            ctx.stroke();
            ctx.restore();
        }

        // Draw camera
        function drawCamera(camera) {
            const pos = worldToScreen(camera.x, camera.y);
            
            ctx.save();
            
            // Draw FOV cone
            if (camera.fov && camera.range) {
                const angleRad = (camera.angle || 0) * Math.PI / 180;
                const fovRad = (camera.fov || 90) * Math.PI / 180;
                const range = camera.range * scale * zoom;
                
                ctx.fillStyle = 'rgba(0, 255, 255, 0.1)';
                ctx.strokeStyle = '#00ffff';
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 5]);
                
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
                ctx.arc(pos.x, pos.y, range, 
                    angleRad - fovRad / 2, 
                    angleRad + fovRad / 2);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
                ctx.setLineDash([]);
            }
            
            // Draw camera icon
            ctx.fillStyle = '#00ffff';
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            ctx.arc(pos.x, pos.y, 8, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            
            // Draw camera ID
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(camera.id || '?', pos.x, pos.y + 25);
            
            ctx.restore();
        }

        // Draw zone
        function drawZone(zone) {
            if (!zone.points || zone.points.length < 2) return;
            
            ctx.save();
            ctx.fillStyle = 'rgba(255, 0, 255, 0.15)';
            ctx.strokeStyle = '#ff00ff';
            ctx.lineWidth = 2;
            ctx.setLineDash([8, 4]);
            
            ctx.beginPath();
            const first = worldToScreen(zone.points[0].x, zone.points[0].y);
            ctx.moveTo(first.x, first.y);
            
            for (let i = 1; i < zone.points.length; i++) {
                const point = worldToScreen(zone.points[i].x, zone.points[i].y);
                ctx.lineTo(point.x, point.y);
            }
            
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            ctx.setLineDash([]);
            
            ctx.restore();
        }

        // Highlight selected object
        function highlightObject(obj) {
            ctx.save();
            ctx.strokeStyle = '#ffff00';
            ctx.lineWidth = 3;
            ctx.setLineDash([5, 5]);
            
            if (obj.type === 'wall') {
                const start = worldToScreen(obj.start.x, obj.start.y);
                const end = worldToScreen(obj.end.x, obj.end.y);
                ctx.beginPath();
                ctx.moveTo(start.x, start.y);
                ctx.lineTo(end.x, end.y);
                ctx.stroke();
            } else if (obj.type === 'camera') {
                const pos = worldToScreen(obj.x, obj.y);
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, 12, 0, Math.PI * 2);
                ctx.stroke();
            }
            
            ctx.restore();
        }

        // Tool selection
        document.querySelectorAll('[data-tool]').forEach(btn => {
            btn.addEventListener('click', function() {
                currentTool = this.dataset.tool;
                
                // Update active states
                document.querySelectorAll('[data-tool]').forEach(b => b.classList.remove('active'));
                document.querySelectorAll(`[data-tool="${currentTool}"]`).forEach(b => b.classList.add('active'));
                
                // Update cursor
                canvas.style.cursor = currentTool === 'pan' ? 'grab' : 'crosshair';
                
                // Show helper text
                showHelper();
            });
        });

        // Show helper text
        function showHelper() {
            const helper = document.getElementById('helperText');
            const messages = {
                select: 'Click to select objects',
                wall: 'Click two points to draw a wall',
                camera: 'Click to place a camera',
                zone: 'Click multiple points to draw a zone, press Enter to finish',
                measure: 'Click two points to measure distance',
                pan: 'Click and drag to pan the view'
            };
            
            helper.textContent = messages[currentTool] || 'Select a tool';
            helper.style.display = 'block';
            
            setTimeout(() => {
                helper.style.display = 'none';
            }, 3000);
        }

        // Mouse events
        let tempPoints = [];
        
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const screenX = e.clientX - rect.left;
            const screenY = e.clientY - rect.top;
            const worldPos = screenToWorld(screenX, screenY);
            const snappedPos = snapPoint(worldPos);
            
            if (currentTool === 'pan') {
                isPanning = true;
                lastPanPoint = { x: e.clientX, y: e.clientY };
                canvas.style.cursor = 'grabbing';
                return;
            }
            
            if (currentTool === 'wall') {
                if (!startPoint) {
                    startPoint = snappedPos;
                } else {
                    objects.push({
                        type: 'wall',
                        start: startPoint,
                        end: snappedPos,
                        color: '#ffffff'
                    });
                    startPoint = null;
                    render();
                }
            } else if (currentTool === 'camera') {
                const cameraId = prompt('Enter Camera ID:');
                if (cameraId) {
                    objects.push({
                        type: 'camera',
                        x: snappedPos.x,
                        y: snappedPos.y,
                        id: parseInt(cameraId),
                        angle: 0,
                        fov: 90,
                        range: 10
                    });
                    render();
                }
            } else if (currentTool === 'zone') {
                tempPoints.push(snappedPos);
                render();
                // Draw temp points
                tempPoints.forEach(p => {
                    const screen = worldToScreen(p.x, p.y);
                    ctx.fillStyle = '#ff00ff';
                    ctx.beginPath();
                    ctx.arc(screen.x, screen.y, 5, 0, Math.PI * 2);
                    ctx.fill();
                });
            } else if (currentTool === 'select') {
                // Find clicked object
                selectedObject = findObjectAt(snappedPos);
                showProperties(selectedObject);
                render();
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const screenX = e.clientX - rect.left;
            const screenY = e.clientY - rect.top;
            const worldPos = screenToWorld(screenX, screenY);
            const snappedPos = snapPoint(worldPos);
            
            // Update coordinates display
            document.getElementById('coords').textContent = 
                `X: ${snappedPos.x.toFixed(2)}m, Y: ${snappedPos.y.toFixed(2)}m`;
            
            if (isPanning && lastPanPoint) {
                const dx = e.clientX - lastPanPoint.x;
                const dy = e.clientY - lastPanPoint.y;
                panOffset.x += dx;
                panOffset.y += dy;
                lastPanPoint = { x: e.clientX, y: e.clientY };
                render();
            }
            
            // Draw preview
            if (startPoint && currentTool === 'wall') {
                render();
                const start = worldToScreen(startPoint.x, startPoint.y);
                const end = worldToScreen(snappedPos.x, snappedPos.y);
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 4;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(start.x, start.y);
                ctx.lineTo(end.x, end.y);
                ctx.stroke();
                ctx.setLineDash([]);
            }
        });

        canvas.addEventListener('mouseup', () => {
            if (isPanning) {
                isPanning = false;
                canvas.style.cursor = 'grab';
            }
        });

        // Finish zone drawing
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && currentTool === 'zone' && tempPoints.length >= 3) {
                objects.push({
                    type: 'zone',
                    points: tempPoints,
                    name: 'Zone ' + (objects.filter(o => o.type === 'zone').length + 1)
                });
                tempPoints = [];
                render();
            } else if (e.key === 'Escape') {
                currentTool = 'select';
                tempPoints = [];
                startPoint = null;
                document.querySelectorAll('[data-tool]').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('[data-tool="select"]').forEach(b => b.classList.add('active'));
                render();
            }
        });

        // Find object at position
        function findObjectAt(pos) {
            // Check cameras first (easier to select)
            for (let i = objects.length - 1; i >= 0; i--) {
                const obj = objects[i];
                if (obj.type === 'camera') {
                    const dist = Math.sqrt(
                        Math.pow(obj.x - pos.x, 2) + 
                        Math.pow(obj.y - pos.y, 2)
                    );
                    if (dist < 1) return obj; // 1 meter tolerance
                }
            }
            
            // Check walls
            for (let i = objects.length - 1; i >= 0; i--) {
                const obj = objects[i];
                if (obj.type === 'wall') {
                    const dist = distanceToLine(pos, obj.start, obj.end);
                    if (dist < 0.5) return obj; // 0.5 meter tolerance
                }
            }
            
            return null;
        }

        // Distance from point to line segment
        function distanceToLine(point, lineStart, lineEnd) {
            const A = point.x - lineStart.x;
            const B = point.y - lineStart.y;
            const C = lineEnd.x - lineStart.x;
            const D = lineEnd.y - lineStart.y;
            
            const dot = A * C + B * D;
            const lenSq = C * C + D * D;
            let param = -1;
            
            if (lenSq !== 0) param = dot / lenSq;
            
            let xx, yy;
            
            if (param < 0) {
                xx = lineStart.x;
                yy = lineStart.y;
            } else if (param > 1) {
                xx = lineEnd.x;
                yy = lineEnd.y;
            } else {
                xx = lineStart.x + param * C;
                yy = lineStart.y + param * D;
            }
            
            const dx = point.x - xx;
            const dy = point.y - yy;
            
            return Math.sqrt(dx * dx + dy * dy);
        }

        // Show properties panel
        function showProperties(obj) {
            document.getElementById('selectionProps').style.display = obj ? 'block' : 'none';
            document.getElementById('cameraProps').style.display = 
                (obj && obj.type === 'camera') ? 'block' : 'none';
            
            if (obj) {
                document.getElementById('objType').value = obj.type;
                if (obj.type === 'camera') {
                    document.getElementById('objX').value = obj.x.toFixed(2);
                    document.getElementById('objY').value = obj.y.toFixed(2);
                    document.getElementById('cameraId').value = obj.id;
                    document.getElementById('cameraAngle').value = obj.angle || 0;
                    document.getElementById('cameraFOV').value = obj.fov || 90;
                    document.getElementById('cameraRange').value = obj.range || 10;
                } else if (obj.type === 'wall') {
                    document.getElementById('objX').value = obj.start.x.toFixed(2);
                    document.getElementById('objY').value = obj.start.y.toFixed(2);
                    document.getElementById('objColor').value = obj.color || '#ffffff';
                }
            }
        }

        // Update object properties
        document.getElementById('cameraAngle')?.addEventListener('input', (e) => {
            if (selectedObject && selectedObject.type === 'camera') {
                selectedObject.angle = parseFloat(e.target.value);
                render();
            }
        });

        document.getElementById('cameraFOV')?.addEventListener('input', (e) => {
            if (selectedObject && selectedObject.type === 'camera') {
                selectedObject.fov = parseFloat(e.target.value);
                render();
            }
        });

        document.getElementById('cameraRange')?.addEventListener('input', (e) => {
            if (selectedObject && selectedObject.type === 'camera') {
                selectedObject.range = parseFloat(e.target.value);
                render();
            }
        });

        // Delete object
        document.getElementById('deleteObj')?.addEventListener('click', () => {
            if (selectedObject) {
                const index = objects.indexOf(selectedObject);
                if (index > -1) {
                    objects.splice(index, 1);
                    selectedObject = null;
                    showProperties(null);
                    render();
                }
            }
        });

        // Zoom controls
        document.getElementById('zoomIn')?.addEventListener('click', () => {
            zoom *= 1.2;
            document.getElementById('zoomLevel').textContent = Math.round(zoom * 100) + '%';
            render();
        });

        document.getElementById('zoomOut')?.addEventListener('click', () => {
            zoom /= 1.2;
            document.getElementById('zoomLevel').textContent = Math.round(zoom * 100) + '%';
            render();
        });

        document.getElementById('zoomFit')?.addEventListener('click', () => {
            zoom = 1;
            panOffset = { x: canvas.width / 2, y: canvas.height / 2 };
            document.getElementById('zoomLevel').textContent = '100%';
            render();
        });

        // Mouse wheel zoom
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            zoom *= delta;
            document.getElementById('zoomLevel').textContent = Math.round(zoom * 100) + '%';
            render();
        });

        // Grid toggle
        document.getElementById('gridToggle')?.addEventListener('click', function() {
            showGrid = !showGrid;
            this.classList.toggle('active');
            render();
        });

        // Snap toggles
        document.getElementById('snapGrid')?.addEventListener('click', function() {
            snapToGrid = !snapToGrid;
            this.classList.toggle('active');
        });

        document.getElementById('snapObject')?.addEventListener('click', function() {
            this.classList.toggle('active');
        });

        document.getElementById('orthoMode')?.addEventListener('click', function() {
            orthoMode = !orthoMode;
            this.classList.toggle('active');
        });

        // Get room ID from URL path
        const roomId = {{ room_id }};
        
        // Load room data on page load
        async function loadRoomData() {
            try {
                const response = await fetch('/vault-rooms/');
                const data = await response.json();
                const room = data.vault_rooms.find(r => r.id === roomId);
                
                if (room) {
                    document.getElementById('roomName').value = room.name;
                    
                    // Load layout if exists
                    if (room.room_layout) {
                        try {
                            const design = JSON.parse(room.room_layout);
                            objects = design.objects || [];
                            scale = design.scale || 20;
                            document.getElementById('scale').value = scale;
                            render();
                        } catch (err) {
                            console.error('Error parsing room layout:', err);
                        }
                    }
                    
                    document.getElementById('statusMsg').textContent = `Loaded: ${room.name}`;
                }
            } catch (err) {
                console.error('Error loading room data:', err);
                document.getElementById('statusMsg').textContent = 'Error loading room';
            }
        }
        
        // Save to database
        document.getElementById('saveDesign')?.addEventListener('click', async () => {
            const design = {
                roomName: document.getElementById('roomName').value,
                scale: scale,
                objects: objects
            };
            
            const layoutData = JSON.stringify(design);
            
            try {
                const formData = new URLSearchParams();
                formData.append('room_id', roomId);
                formData.append('name', design.roomName);
                formData.append('location', 'Unknown'); // Will keep existing location
                formData.append('width', 10); // Default dimensions
                formData.append('height', 8);
                formData.append('layout_data', layoutData);
                
                const response = await fetch('/vault-rooms/save-layout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData.toString()
                });
                
                if (response.ok) {
                    document.getElementById('statusMsg').textContent = 'Design saved to database!';
                    setTimeout(() => {
                        document.getElementById('statusMsg').textContent = 'Ready';
                    }, 2000);
                } else {
                    throw new Error('Failed to save');
                }
            } catch (err) {
                console.error('Error saving:', err);
                alert('Error saving design: ' + err.message);
            }
        });

        // Export to file (keep for backup)
        document.getElementById('exportPNG')?.addEventListener('click', () => {
            const design = {
                roomName: document.getElementById('roomName').value,
                scale: scale,
                objects: objects
            };
            
            const json = JSON.stringify(design, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `room-${roomId}-design.json`;
            a.click();
        });

        document.getElementById('loadDesign')?.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const design = JSON.parse(event.target.result);
                        objects = design.objects || [];
                        scale = design.scale || 20;
                        document.getElementById('roomName').value = design.roomName || 'Office';
                        document.getElementById('scale').value = scale;
                        render();
                        document.getElementById('statusMsg').textContent = 'Design loaded from file!';
                        setTimeout(() => {
                            document.getElementById('statusMsg').textContent = 'Ready';
                        }, 2000);
                    } catch (err) {
                        alert('Error loading design: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        });

        // Initial render
        panOffset = { x: canvas.width / 2, y: canvas.height / 2 };
        render();
        showHelper();
        
        // Load room data from database
        loadRoomData();
    </script>
</body>
</html>

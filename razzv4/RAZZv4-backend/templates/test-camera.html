<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Camera Stream</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Camera Stream Test</h1>
        
        <div class="mb-6 space-y-4">
            <div>
                <label class="block mb-2">RTSP URL:</label>
                <input 
                    type="text" 
                    id="rtspUrl" 
                    class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded"
                    placeholder="rtsp://admin:password@192.168.1.186:554/Streaming/Channels/101"
                    value="rtsp://admin:tt55oo77@192.168.1.186:554/Streaming/Channels/101"
                >
            </div>
            
            <button 
                onclick="startStream()" 
                class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded font-medium"
            >
                Start Stream
            </button>
            
            <button 
                onclick="stopStream()" 
                class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded font-medium"
            >
                Stop Stream
            </button>
        </div>
        
        <div class="mb-4">
            <div class="bg-gray-800 p-4 rounded">
                <h2 class="font-bold mb-2">Status: <span id="status" class="text-yellow-400">Ready</span></h2>
                <div id="logs" class="text-sm text-gray-400 space-y-1 max-h-40 overflow-auto font-mono">
                    <div>Ready to connect...</div>
                </div>
            </div>
        </div>
        
        <div class="bg-black rounded-lg overflow-hidden">
            <video 
                id="videoPlayer" 
                autoplay 
                muted 
                playsinline 
                class="w-full"
                style="max-height: 600px;"
            ></video>
        </div>
        
        <div class="mt-4 text-sm text-gray-400">
            <p><strong>Server:</strong> https://aqlinks.com/rtsp/stream</p>
            <p><strong>Connection:</strong> WebRTC over HTTPS</p>
            <p><strong>ICE Servers:</strong> STUN (Google)</p>
        </div>
    </div>

    <script>
        let pc = null;
        
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-gray-400';
            logs.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }
        
        function setStatus(text, type = 'info') {
            const status = document.getElementById('status');
            const colors = {
                'info': 'text-blue-400',
                'success': 'text-green-400',
                'error': 'text-red-400',
                'warning': 'text-yellow-400'
            };
            status.className = colors[type] || colors['info'];
            status.textContent = text;
        }
        
        async function startStream() {
            const rtspUrl = document.getElementById('rtspUrl').value.trim();
            
            if (!rtspUrl) {
                log('Please enter an RTSP URL', 'error');
                return;
            }
            
            if (pc) {
                log('Stopping existing connection...', 'warning');
                stopStream();
            }
            
            try {
                setStatus('Connecting...', 'warning');
                log('Starting WebRTC connection...', 'info');
                
                // Create peer connection
                pc = new RTCPeerConnection({
                    iceServers: [
                        {urls: 'stun:stun.l.google.com:19302'},
                        {urls: 'stun:stun1.l.google.com:19302'},
                        {urls: 'stun:stun2.l.google.com:19302'}
                    ],
                    iceTransportPolicy: 'all'
                });
                
                log('PeerConnection created', 'success');
                
                // Add transceiver to receive video
                pc.addTransceiver('video', {'direction': 'recvonly'});
                log('Video transceiver added', 'success');
                
                // Handle incoming tracks
                pc.ontrack = (event) => {
                    log('Received media track!', 'success');
                    const video = document.getElementById('videoPlayer');
                    video.srcObject = event.streams[0];
                    setStatus('Playing', 'success');
                };
                
                // Monitor connection state
                pc.oniceconnectionstatechange = () => {
                    log(`ICE Connection State: ${pc.iceConnectionState}`, 'info');
                    if (pc.iceConnectionState === 'connected') {
                        setStatus('Connected', 'success');
                    } else if (pc.iceConnectionState === 'failed') {
                        setStatus('Connection Failed', 'error');
                        log('ICE connection failed', 'error');
                    }
                };
                
                pc.onconnectionstatechange = () => {
                    log(`Connection State: ${pc.connectionState}`, 'info');
                };
                
                pc.onicegatheringstatechange = () => {
                    log(`ICE Gathering State: ${pc.iceGatheringState}`, 'info');
                };
                
                // Create offer
                log('Creating SDP offer...', 'info');
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                log('Local description set', 'success');
                
                // Send to RTSPtoWebRTC server
                const sdp64 = btoa(offer.sdp);
                log('Sending offer to RTSPtoWebRTC server...', 'info');
                
                const formData = new FormData();
                formData.append('url', rtspUrl);
                formData.append('sdp64', sdp64);
                
                const response = await fetch('https://aqlinks.com/rtsp/stream', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server returned ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                log(`Server response received. Tracks: ${data.tracks.join(', ')}`, 'success');
                
                // Set remote description
                const answerSdp = atob(data.sdp64);
                await pc.setRemoteDescription(new RTCSessionDescription({
                    type: 'answer',
                    sdp: answerSdp
                }));
                
                log('Remote description set', 'success');
                log('WebRTC negotiation complete. Waiting for media...', 'success');
                setStatus('Waiting for video...', 'warning');
                
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                setStatus('Error', 'error');
                console.error('Full error:', error);
            }
        }
        
        function stopStream() {
            if (pc) {
                log('Closing connection...', 'warning');
                pc.close();
                pc = null;
                
                const video = document.getElementById('videoPlayer');
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                    video.srcObject = null;
                }
                
                setStatus('Stopped', 'info');
                log('Connection closed', 'success');
            }
        }
    </script>
</body>
</html>

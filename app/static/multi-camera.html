<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Camera Security Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        .camera-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            align-items: center;
        }
        .camera-selector label {
            font-weight: bold;
        }
        select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .cameras-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .camera-card {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            background: #f8f9fa;
        }
        .camera-card.active {
            border-color: #007bff;
        }
        .camera-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .camera-title {
            font-size: 18px;
            font-weight: bold;
        }
        .camera-status {
            padding: 4px 8px;
            border-radius: 3px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        .status.connected { background: #28a745; }
        .status.disconnected { background: #dc3545; }
        .status.failed { background: #ffc107; color: #000; }
        .camera-frame {
            text-align: center;
            margin-bottom: 10px;
        }
        .camera-frame img {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .no-frame {
            padding: 50px;
            background: #e9ecef;
            border: 2px dashed #ced4da;
            border-radius: 5px;
            color: #6c757d;
            text-align: center;
        }
        .camera-controls {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        .camera-controls button {
            padding: 5px 10px;
            font-size: 12px;
        }
        .motion-alert {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        .motion-alert.show {
            display: block;
        }
        .info-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        .summary-card {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .summary-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ”’ Multi-Camera Security Dashboard</h1>
            <p>Real-time RTSP camera monitoring with motion detection for 4 cameras</p>
        </div>

        <div class="summary-grid">
            <div class="summary-card">
                <div class="summary-number" id="totalCameras">4</div>
                <div>Total Cameras</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" id="connectedCameras">0</div>
                <div>Connected</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" id="motionDetected">0</div>
                <div>Motion Alerts</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" id="lastUpdate">--:--</div>
                <div>Last Update</div>
            </div>
        </div>

        <div class="controls">
            <button onclick="getAllCamerasInfo()">Refresh All Status</button>
            <button onclick="getAllFrames()">Capture All Frames</button>
            <button onclick="detectMotionAllCameras()">Detect Motion (All)</button>
            <button onclick="initializeAllCameras()">Initialize All</button>
            <button onclick="toggleAutoRefresh()">Toggle Auto Refresh</button>
            <button onclick="viewSingleCamera()" class="danger">Single Camera View</button>
        </div>

        <div class="camera-selector" id="singleCameraSelector" style="display: none;">
            <label>Select Camera:</label>
            <select id="cameraSelect">
                <option value="1">Camera 1</option>
                <option value="2">Camera 2</option>
                <option value="3">Camera 3</option>
                <option value="4">Camera 4</option>
            </select>
            <button onclick="showGridView()">Back to Grid View</button>
        </div>

        <div class="motion-alert" id="motionAlert">
            ðŸš¨ Motion detected in security cameras!
        </div>

        <div class="cameras-grid" id="camerasGrid">
            <!-- Camera cards will be generated here -->
        </div>

        <div class="info-panel">
            <div class="info-box">
                <h3>System Status</h3>
                <div id="systemStatus">Loading...</div>
            </div>
            <div class="info-box">
                <h3>Motion Detection Log</h3>
                <div id="motionLog">No motion detected yet...</div>
            </div>
        </div>
    </div>

    <script>
        let autoRefresh = false;
        let refreshInterval;
        let singleCameraMode = false;
        let motionLog = [];

        function initializeCameraGrid() {
            const grid = document.getElementById('camerasGrid');
            grid.innerHTML = '';
            
            const cameras = singleCameraMode ? [parseInt(document.getElementById('cameraSelect').value)] : [1, 2, 3, 4];
            
            cameras.forEach(cameraId => {
                const cameraCard = document.createElement('div');
                cameraCard.className = 'camera-card';
                cameraCard.id = `camera-${cameraId}`;
                
                cameraCard.innerHTML = `
                    <div class="camera-header">
                        <div class="camera-title">Camera ${cameraId}</div>
                        <div class="camera-status status disconnected" id="status-${cameraId}">Disconnected</div>
                    </div>
                    <div class="camera-frame">
                        <div class="no-frame" id="frame-${cameraId}">
                            No frame available<br>
                            <small>Camera ${cameraId}</small>
                        </div>
                    </div>
                    <div class="camera-controls">
                        <button onclick="getCameraFrame(${cameraId})">Capture</button>
                        <button onclick="detectMotion(${cameraId})">Motion</button>
                        <button onclick="initializeCamera(${cameraId})">Init</button>
                        <button onclick="getCameraInfo(${cameraId})">Info</button>
                    </div>
                `;
                
                grid.appendChild(cameraCard);
            });
        }

        async function getAllCamerasInfo() {
            try {
                const response = await fetch('/cameras/info');
                const data = await response.json();
                
                updateSystemStatus(data);
                
                Object.entries(data.cameras).forEach(([cameraId, info]) => {
                    updateCameraStatus(parseInt(cameraId), info);
                });
                
                updateLastUpdate();
            } catch (error) {
                console.error('Error getting all cameras info:', error);
            }
        }

        async function getCameraInfo(cameraId) {
            try {
                const response = await fetch(`/camera/info?camera_id=${cameraId}`);
                const data = await response.json();
                updateCameraStatus(cameraId, data);
            } catch (error) {
                console.error(`Error getting camera ${cameraId} info:`, error);
            }
        }

        async function getCameraFrame(cameraId) {
            try {
                const response = await fetch(`/camera/frame?camera_id=${cameraId}`);
                const data = await response.json();
                
                if (data.success && data.frame) {
                    const frameContainer = document.getElementById(`frame-${cameraId}`);
                    frameContainer.innerHTML = `<img src="data:image/jpeg;base64,${data.frame}" alt="Camera ${cameraId} feed">`;
                } else {
                    console.log(`No frame available for camera ${cameraId}`);
                }
            } catch (error) {
                console.error(`Error getting frame from camera ${cameraId}:`, error);
            }
        }

        async function getAllFrames() {
            const cameras = singleCameraMode ? [parseInt(document.getElementById('cameraSelect').value)] : [1, 2, 3, 4];
            for (const cameraId of cameras) {
                await getCameraFrame(cameraId);
            }
        }

        async function detectMotion(cameraId) {
            try {
                const response = await fetch(`/camera/motion?camera_id=${cameraId}`);
                const data = await response.json();
                
                if (data.success) {
                    if (data.motion_detected) {
                        addMotionLog(cameraId);
                        showMotionAlert();
                    }
                    
                    if (data.frame_with_annotations) {
                        const frameContainer = document.getElementById(`frame-${cameraId}`);
                        frameContainer.innerHTML = `<img src="data:image/jpeg;base64,${data.frame_with_annotations}" alt="Camera ${cameraId} with motion detection">`;
                    }
                }
            } catch (error) {
                console.error(`Error detecting motion on camera ${cameraId}:`, error);
            }
        }

        async function detectMotionAllCameras() {
            try {
                const response = await fetch('/cameras/motion');
                const data = await response.json();
                
                if (data.success) {
                    let motionCount = 0;
                    
                    Object.entries(data.cameras).forEach(([cameraId, result]) => {
                        if (result.motion_detected) {
                            motionCount++;
                            addMotionLog(parseInt(cameraId));
                        }
                        
                        if (result.frame) {
                            const frameContainer = document.getElementById(`frame-${cameraId}`);
                            if (frameContainer) {
                                frameContainer.innerHTML = `<img src="data:image/jpeg;base64,${result.frame}" alt="Camera ${cameraId} with motion detection">`;
                            }
                        }
                    });
                    
                    if (motionCount > 0) {
                        showMotionAlert();
                    }
                    
                    document.getElementById('motionDetected').textContent = motionCount;
                }
            } catch (error) {
                console.error('Error detecting motion on all cameras:', error);
            }
        }

        async function initializeCamera(cameraId) {
            try {
                const response = await fetch(`/camera/initialize?camera_id=${cameraId}`, { method: 'POST' });
                const data = await response.json();
                alert(`Camera ${cameraId}: ${data.message}`);
                getCameraInfo(cameraId);
            } catch (error) {
                console.error(`Error initializing camera ${cameraId}:`, error);
            }
        }

        async function initializeAllCameras() {
            try {
                const response = await fetch('/cameras/initialize', { method: 'POST' });
                const data = await response.json();
                
                const summary = data.summary;
                alert(`Initialization complete: ${summary.connected}/${summary.total} cameras connected`);
                
                getAllCamerasInfo();
            } catch (error) {
                console.error('Error initializing all cameras:', error);
            }
        }

        function updateCameraStatus(cameraId, info) {
            const statusElement = document.getElementById(`status-${cameraId}`);
            if (statusElement) {
                statusElement.className = `camera-status status ${info.status}`;
                statusElement.textContent = info.status.charAt(0).toUpperCase() + info.status.slice(1);
            }
        }

        function updateSystemStatus(data) {
            const connectedCount = Object.values(data.cameras).filter(info => info.status === 'connected').length;
            document.getElementById('connectedCameras').textContent = connectedCount;
            document.getElementById('totalCameras').textContent = data.total_cameras;
            
            const statusText = `${connectedCount}/${data.total_cameras} cameras connected`;
            document.getElementById('systemStatus').textContent = statusText;
        }

        function addMotionLog(cameraId) {
            const timestamp = new Date().toLocaleTimeString();
            motionLog.unshift(`${timestamp} - Motion detected on Camera ${cameraId}`);
            
            // Keep only last 10 entries
            if (motionLog.length > 10) {
                motionLog = motionLog.slice(0, 10);
            }
            
            document.getElementById('motionLog').innerHTML = motionLog.join('<br>');
        }

        function showMotionAlert() {
            const motionAlert = document.getElementById('motionAlert');
            motionAlert.classList.add('show');
            setTimeout(() => motionAlert.classList.remove('show'), 5000);
        }

        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
        }

        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            
            if (autoRefresh) {
                refreshInterval = setInterval(() => {
                    detectMotionAllCameras();
                    getAllCamerasInfo();
                }, 3000); // Refresh every 3 seconds
                alert('Auto refresh enabled (every 3 seconds)');
            } else {
                clearInterval(refreshInterval);
                alert('Auto refresh disabled');
            }
        }

        function viewSingleCamera() {
            singleCameraMode = true;
            document.getElementById('singleCameraSelector').style.display = 'flex';
            initializeCameraGrid();
        }

        function showGridView() {
            singleCameraMode = false;
            document.getElementById('singleCameraSelector').style.display = 'none';
            initializeCameraGrid();
        }

        // Initialize on page load
        window.onload = function() {
            initializeCameraGrid();
            getAllCamerasInfo();
        };

        // Update single camera view when selection changes
        document.getElementById('cameraSelect').addEventListener('change', function() {
            if (singleCameraMode) {
                initializeCameraGrid();
            }
        });
    </script>
</body>
</html>

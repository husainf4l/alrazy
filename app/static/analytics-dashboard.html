<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al Razy Pharmacy - Security Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            height: 100vh;
            overflow: hidden;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            height: 100vh;
            overflow-y: auto;
            box-sizing: border-box;
        }
        .header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 350px;
            overflow: hidden;
        }
        .chart-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        .time-selector {
            margin: 10px;
        }
        select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .nav-bar {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        .nav-link {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .nav-link:hover {
            background: linear-gradient(135deg, #0056b3, #004085);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,123,255,0.3);
        }
        .nav-link.current {
            background: linear-gradient(135deg, #28a745, #1e7e34);
        }
        .nav-link.streaming {
            background: linear-gradient(135deg, #dc3545, #bd2130);
        }
        .nav-link.analytics {
            background: linear-gradient(135deg, #6f42c1, #5a2d91);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Al Razy Pharmacy - Security Analytics</h1>
            <p>Advanced Analytics and Insights for Theft Prevention</p>
        </div>

        <!-- Navigation Bar -->
        <div class="nav-bar">
            <a href="/security-dashboard" class="nav-link">
                üîí Security Dashboard
            </a>
            <a href="/streaming-dashboard" class="nav-link streaming">
                üìπ Live Cameras
            </a>
            <a href="/multi-camera" class="nav-link streaming">
                üì∫ Multi-Camera View
            </a>
            <a href="/analytics-dashboard" class="nav-link analytics current">
                üìä Analytics
            </a>
            <a href="/" class="nav-link">
                üè† Home
            </a>
        </div>

        <div class="controls">
            <div class="time-selector">
                <label>Time Period:</label>
                <select id="timePeriod" onchange="updateAnalytics()">
                    <option value="24">Last 24 Hours</option>
                    <option value="168">Last Week</option>
                    <option value="720">Last Month</option>
                </select>
            </div>
            <button onclick="updateAnalytics()">üîÑ Refresh Data</button>
            <button onclick="exportReport()">üìä Export Report</button>
            <button onclick="window.open('/dashboard/security', '_blank')">üîí Security Dashboard</button>
        </div>

        <!-- Key Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalEvents">0</div>
                <div class="stat-label">Total Security Events</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="confirmedThreats">0</div>
                <div class="stat-label">Confirmed Threats</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="falsePosRate">0%</div>
                <div class="stat-label">False Positive Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgResponse">0s</div>
                <div class="stat-label">Avg Response Time</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="recordingsCreated">0</div>
                <div class="stat-label">Recordings Created</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="alertsSent">0</div>
                <div class="stat-label">Alerts Sent</div>
            </div>
        </div>

        <!-- Analytics Charts -->
        <div class="analytics-grid">
            <!-- Activity Distribution -->
            <div class="chart-card">
                <div class="chart-title">Activity Type Distribution</div>
                <canvas id="activityChart" width="400" height="300"></canvas>
            </div>

            <!-- Threat Level Trends -->
            <div class="chart-card">
                <div class="chart-title">Threat Level Distribution</div>
                <canvas id="threatChart" width="400" height="300"></canvas>
            </div>

            <!-- Camera Activity -->
            <div class="chart-card">
                <div class="chart-title">Camera Activity Comparison</div>
                <canvas id="cameraChart" width="400" height="300"></canvas>
            </div>

            <!-- Hourly Activity Pattern -->
            <div class="chart-card">
                <div class="chart-title">Hourly Activity Pattern</div>
                <canvas id="hourlyChart" width="400" height="300"></canvas>
            </div>

            <!-- System Performance -->
            <div class="chart-card">
                <div class="chart-title">System Performance Metrics</div>
                <canvas id="performanceChart" width="400" height="300"></canvas>
            </div>

            <!-- Risk Score Trend -->
            <div class="chart-card">
                <div class="chart-title">Risk Score Trend (Last 24h)</div>
                <canvas id="riskTrendChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>

    <script>
        class SecurityAnalytics {
            constructor() {
                this.charts = {};
                this.refreshInterval = null;
                this.destroyed = false;
                this.initializeCharts();
                this.updateAnalytics();
                
                // Auto refresh every 30 seconds
                this.startAutoRefresh();
                
                // Add cleanup on page unload
                window.addEventListener('beforeunload', () => this.cleanup());
            }

            cleanup() {
                this.destroyed = true;
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                    this.refreshInterval = null;
                }
                
                // Destroy all charts to prevent memory leaks
                Object.values(this.charts).forEach(chart => {
                    if (chart && chart.destroy) {
                        chart.destroy();
                    }
                });
                this.charts = {};
            }

            startAutoRefresh() {
                // Clear any existing interval first
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                }
                
                this.refreshInterval = setInterval(() => {
                    if (!this.destroyed) {
                        this.updateAnalytics();
                    }
                }, 30000);
            }

            initializeCharts() {
                // Activity Distribution Chart
                this.charts.activity = new Chart(document.getElementById('activityChart'), {
                    type: 'doughnut',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });

                // Threat Level Chart
                this.charts.threat = new Chart(document.getElementById('threatChart'), {
                    type: 'bar',
                    data: {
                        labels: ['MINIMAL', 'LOW', 'MEDIUM', 'HIGH', 'CRITICAL'],
                        datasets: [{
                            label: 'Events',
                            data: [0, 0, 0, 0, 0],
                            backgroundColor: ['#6c757d', '#28a745', '#ffc107', '#fd7e14', '#dc3545']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Camera Activity Chart
                this.charts.camera = new Chart(document.getElementById('cameraChart'), {
                    type: 'bar',
                    data: {
                        labels: ['Camera 1', 'Camera 2', 'Camera 3', 'Camera 4'],
                        datasets: [{
                            label: 'Events Detected',
                            data: [0, 0, 0, 0],
                            backgroundColor: '#007bff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Hourly Activity Chart
                this.charts.hourly = new Chart(document.getElementById('hourlyChart'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: 'Activity Count',
                            data: new Array(24).fill(0),
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Performance Chart
                this.charts.performance = new Chart(document.getElementById('performanceChart'), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Processing Time (s)',
                                data: [],
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                yAxisID: 'y'
                            },
                            {
                                label: 'System Load (%)',
                                data: [],
                                borderColor: '#ffc107',
                                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                beginAtZero: true
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                beginAtZero: true,
                                max: 100,
                                grid: {
                                    drawOnChartArea: false,
                                }
                            }
                        }
                    }
                });

                // Risk Score Trend
                this.charts.riskTrend = new Chart(document.getElementById('riskTrendChart'), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Risk Score',
                            data: [],
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 1
                            }
                        }
                    }
                });
            }

            async updateAnalytics() {
                if (this.destroyed) return;
                
                const timePeriod = document.getElementById('timePeriod').value;
                
                try {
                    // Get analytics data
                    const response = await fetch('/security/analytics');
                    const data = await response.json();
                    
                    if (data.success && !this.destroyed) {
                        this.updateStatistics(data.analytics);
                        this.updateCharts(data.analytics);
                    }

                    // Get events data
                    const eventsResponse = await fetch(`/security/events?hours=${timePeriod}`);
                    const eventsData = await eventsResponse.json();
                    
                    if (eventsData.success && !this.destroyed) {
                        this.updateChartsWithEvents(eventsData.events);
                    }

                } catch (error) {
                    if (!this.destroyed) {
                        console.error('Error updating analytics:', error);
                    }
                }
            }

            updateStatistics(analytics) {
                // Check if we have actual analytics data or just a message
                if (analytics.message) {
                    // No data available - show zeros
                    document.getElementById('totalEvents').textContent = '0';
                    document.getElementById('confirmedThreats').textContent = '0';
                    document.getElementById('falsePosRate').textContent = '0.0%';
                    document.getElementById('avgResponse').textContent = '0.00s';
                    document.getElementById('recordingsCreated').textContent = '0';
                    document.getElementById('alertsSent').textContent = '0';
                    
                    // Show a message
                    this.showNoDataMessage(analytics.message);
                    return;
                }
                
                // Update with actual data
                document.getElementById('totalEvents').textContent = analytics.total_events || 0;
                document.getElementById('confirmedThreats').textContent = analytics.confirmed_threats || 0;
                document.getElementById('falsePosRate').textContent = 
                    ((analytics.false_positive_rate || 0) * 100).toFixed(1) + '%';
                document.getElementById('avgResponse').textContent = 
                    (analytics.average_processing_time || 0).toFixed(2) + 's';
                document.getElementById('recordingsCreated').textContent = analytics.recordings_created || 0;
                
                // This would need to be added to the analytics endpoint
                document.getElementById('alertsSent').textContent = '0'; // Placeholder
            }

            updateCharts(analytics) {
                if (this.destroyed) return;
                
                // Check if we have actual analytics data
                if (analytics.message) {
                    // No data available - show empty charts
                    this.createEmptyCharts();
                    return;
                }
                
                // Update activity distribution
                if (analytics.activity_distribution && this.charts.activity && !this.destroyed) {
                    const activityData = analytics.activity_distribution;
                    this.charts.activity.data.labels = Object.keys(activityData).map(this.formatActivityType);
                    this.charts.activity.data.datasets[0].data = Object.values(activityData);
                    this.charts.activity.update('none');
                }

                // Update threat level distribution
                if (analytics.threat_distribution && this.charts.threat && !this.destroyed) {
                    const threatData = analytics.threat_distribution;
                    const levels = ['MINIMAL', 'LOW', 'MEDIUM', 'HIGH', 'CRITICAL'];
                    this.charts.threat.data.datasets[0].data = levels.map(level => threatData[level] || 0);
                    this.charts.threat.update('none');
                }

                // Update camera activity
                if (analytics.camera_activity && this.charts.camera && !this.destroyed) {
                    const cameraData = analytics.camera_activity;
                    this.charts.camera.data.datasets[0].data = [1, 2, 3, 4].map(id => cameraData[id] || 0);
                    this.charts.camera.update('none');
                }
            }

            updateChartsWithEvents(events) {
                if (this.destroyed) return;
                
                // Update hourly pattern
                const hourlyData = new Array(24).fill(0);
                events.forEach(event => {
                    const hour = new Date(event.timestamp * 1000).getHours();
                    hourlyData[hour]++;
                });
                
                if (this.charts.hourly && !this.destroyed) {
                    this.charts.hourly.data.datasets[0].data = hourlyData;
                    this.charts.hourly.update('none'); // Use 'none' animation to prevent flickering
                }

                // Update performance metrics (mock data for now)
                const now = new Date();
                const labels = [];
                const processingTimes = [];
                const systemLoads = [];
                
                for (let i = 23; i >= 0; i--) {
                    const time = new Date(now.getTime() - i * 60 * 60 * 1000);
                    labels.push(time.getHours() + ':00');
                    processingTimes.push(Math.random() * 2 + 0.5); // Mock processing time
                    systemLoads.push(Math.random() * 30 + 20); // Mock system load
                }
                
                if (this.charts.performance && !this.destroyed) {
                    this.charts.performance.data.labels = labels;
                    this.charts.performance.data.datasets[0].data = processingTimes;
                    this.charts.performance.data.datasets[1].data = systemLoads;
                    this.charts.performance.update('none');
                }

                // Update risk score trend (mock data for now)
                const riskLabels = [];
                const riskScores = [];
                
                for (let i = 23; i >= 0; i--) {
                    const time = new Date(now.getTime() - i * 60 * 60 * 1000);
                    riskLabels.push(time.getHours() + ':00');
                    riskScores.push(Math.random() * 0.8); // Mock risk score
                }
                
                if (this.charts.riskTrend && !this.destroyed) {
                    this.charts.riskTrend.data.labels = riskLabels;
                    this.charts.riskTrend.data.datasets[0].data = riskScores;
                    this.charts.riskTrend.update('none');
                }
            }

            formatActivityType(type) {
                return type.split('_').map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ');
            }

            exportReport() {
                // Create a simple report
                const timePeriod = document.getElementById('timePeriod').value;
                const reportData = {
                    timestamp: new Date().toISOString(),
                    period: `${timePeriod} hours`,
                    statistics: {
                        totalEvents: document.getElementById('totalEvents').textContent,
                        confirmedThreats: document.getElementById('confirmedThreats').textContent,
                        falsePosRate: document.getElementById('falsePosRate').textContent,
                        avgResponse: document.getElementById('avgResponse').textContent,
                        recordingsCreated: document.getElementById('recordingsCreated').textContent,
                        alertsSent: document.getElementById('alertsSent').textContent
                    }
                };

                const blob = new Blob([JSON.stringify(reportData, null, 2)], 
                    { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `security-report-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
            
            showNoDataMessage(message) {
                // Show a friendly message when no data is available
                const noDataDiv = document.getElementById('noDataMessage') || this.createNoDataDiv();
                noDataDiv.textContent = message;
                noDataDiv.style.display = 'block';
            }
            
            createNoDataDiv() {
                const div = document.createElement('div');
                div.id = 'noDataMessage';
                div.style.cssText = `
                    background: #fff3cd;
                    border: 1px solid #ffeaa7;
                    color: #856404;
                    padding: 15px;
                    border-radius: 5px;
                    text-align: center;
                    margin: 20px 0;
                    font-size: 16px;
                `;
                document.querySelector('.container').appendChild(div);
                return div;
            }
            
            createEmptyCharts() {
                if (this.destroyed) return;
                
                // Only update the data of existing charts, do NOT create new charts or call non-existent methods
                // Activity Distribution
                if (this.charts.activity) {
                    this.charts.activity.data.labels = ['No Activity Detected'];
                    this.charts.activity.data.datasets[0].data = [1];
                    this.charts.activity.update('none');
                }

                // Threat Level Distribution
                if (this.charts.threat) {
                    this.charts.threat.data.datasets[0].data = [0, 0, 0, 0, 0];
                    this.charts.threat.update('none');
                }

                // Camera Activity
                if (this.charts.camera) {
                    this.charts.camera.data.datasets[0].data = [0, 0, 0, 0];
                    this.charts.camera.update('none');
                }

                // Hourly Activity Pattern
                if (this.charts.hourly) {
                    this.charts.hourly.data.datasets[0].data = new Array(24).fill(0);
                    this.charts.hourly.update('none');
                }

                // Performance Chart
                if (this.charts.performance) {
                    this.charts.performance.data.labels = [];
                    this.charts.performance.data.datasets[0].data = [];
                    this.charts.performance.data.datasets[1].data = [];
                    this.charts.performance.update('none');
                }

                // Risk Score Trend
                if (this.charts.riskTrend) {
                    this.charts.riskTrend.data.labels = [];
                    this.charts.riskTrend.data.datasets[0].data = [];
                    this.charts.riskTrend.update('none');
                }
            }
        }

        // Global functions
        function updateAnalytics() {
            if (window.analytics && !window.analytics.destroyed) {
                window.analytics.updateAnalytics();
            }
        }

        function exportReport() {
            if (window.analytics && !window.analytics.destroyed) {
                window.analytics.exportReport();
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Prevent multiple instances
            if (window.analytics) {
                window.analytics.cleanup();
            }
            window.analytics = new SecurityAnalytics();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (window.analytics) {
                window.analytics.cleanup();
            }
        });

        // Prevent back button issues
        window.addEventListener('pageshow', (event) => {
            if (event.persisted && window.analytics) {
                window.analytics.cleanup();
                window.analytics = new SecurityAnalytics();
            }
        });
    </script>
</body>
</html>
